<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 7.3.0">

  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" integrity="sha256-dABdfBfUoC8vJUBOwGVdm8L9qlMWaHTIfXt+7GnZCIo=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.23.1","exturl":false,"sidebar":{"position":"left","width_expanded":320,"width_dual_column":240,"display":"post","padding":18,"offset":12},"hljswrap":true,"codeblock":{"theme":{"light":"default","dark":"stackoverflow-dark"},"prism":{"light":"prism","dark":"prism-dark"},"copy_button":{"enable":false,"style":null},"fold":{"enable":false,"height":500},"language":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"duration":200,"transition":{"menu_item":"fadeInDown","post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js" defer></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Qing Yun">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/">


<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  








  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous" defer></script>
<script src="/js/utils.js" defer></script><script src="/js/motion.js" defer></script><script src="/js/sidebar.js" defer></script><script src="/js/next-boot.js" defer></script>

  






  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <div class="column">
      <header class="header" itemscope itemtype="http://schema.org/WPHeader"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger" aria-label="Search" role="button">
    </div>
  </div>
</div>







</header>
        
  
  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Qing Yun</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">6</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>

        </div>
      </div>
    </div>

    
  </aside>


    </div>

    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/09/%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7/watchMOD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qing Yun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/09/%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7/watchMOD/" class="post-title-link" itemprop="url">杀戮尖塔女巫汉化模组</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-09 23:32:53" itemprop="dateCreated datePublished" datetime="2025-04-09T23:32:53+00:00">2025-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-06 00:32:32" itemprop="dateModified" datetime="2025-06-06T00:32:32+00:00">2025-06-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本仓库为女巫模组的汉化版本，原模组仓库地址：https:\github.com\gygrazok\witchmod</p>
<h1 id="女巫（The-Witch）"><a href="#女巫（The-Witch）" class="headerlink" title="女巫（The Witch）"></a>女巫（The Witch）</h1><p><strong>杀戮尖塔（Slay The Spire）</strong> 的全新角色模组</p>
<p>女巫模组为游戏增添了超过 75 张新卡牌和 4 个全新遗物，围绕 <strong>诅咒（Curses）</strong> 展开独特的玩法体验。她的起始遗物 <strong>黑猫（Black Cat）</strong> 每场战斗开始时会在抽牌堆中加入一张临时随机诅咒牌，但每当你抽到诅咒牌时可获得 1 点额外能量。这一机制打破了诅咒牌的传统负面印象，令其在女巫的卡组中可能成为战略优势。</p>
<p>与铁卫（Ironclad）或寂静猎手（Silent）相比，女巫在游戏初期可能略显脆弱，玩法策略需要一定的探索和练习。希望玩家们能够分享宝贵的意见和建议，以帮助进一步平衡和优化她的游戏体验。</p>
<p>卡牌详细列表请参见 <a target="_blank" rel="noopener" href="https://docs.google.com/spreadsheets/d/19tAd2g6CMNSAXdArFp2ZNpAosv3Rltb3qv1Cnc40RSk/edit?usp=sharing">此处</a>。</p>
<h2 id="核心机制"><a href="#核心机制" class="headerlink" title="核心机制"></a>核心机制</h2><ul>
<li><strong>循环（Recurrent）</strong>：打出后不会进入弃牌堆，而是直接洗回抽牌堆，增强卡组的循环效率。</li>
<li><strong>净化（Cleanse）</strong>：部分特殊诅咒牌可在战斗中完成特定目标后被“净化”，解锁其隐藏效果，但该效果仅限于当前战斗。</li>
</ul>
<h2 id="新增状态效果"><a href="#新增状态效果" class="headerlink" title="新增状态效果"></a>新增状态效果</h2><ul>
<li><strong>腐烂（Rot）</strong>：类似中毒，每回合对敌方造成伤害，且与中毒不同，腐烂会在每回合自动 <strong>增加</strong> 1 点。</li>
<li><strong>衰弱（Decrepit）</strong>：使受影响生物承受额外伤害，额外伤害数值取决于衰弱层数，每回合减少 1 层。</li>
</ul>
<h1 id="安装指南"><a href="#安装指南" class="headerlink" title="安装指南"></a>安装指南</h1><p>本模组基于 <a target="_blank" rel="noopener" href="https://github.com/gskleres/FruityMod-StS">FruityMod-StS</a> 的安装指南整理，简明易懂，便于快速上手。</p>
<h2 id="前置要求"><a href="#前置要求" class="headerlink" title="前置要求"></a>前置要求</h2><ul>
<li>Java 8（JRE）— 仅支持 Java 8，Java 9 兼容性问题尚在处理。</li>
<li>BaseMod v3.3.0+（<a target="_blank" rel="noopener" href="https://github.com/daviscook477/BaseMod/releases">下载地址</a>）</li>
<li>ModTheSpire v3.2.0+（<a target="_blank" rel="noopener" href="https://github.com/kiooeht/ModTheSpire/releases">下载地址</a>）</li>
</ul>
<h2 id="安装步骤"><a href="#安装步骤" class="headerlink" title="安装步骤"></a>安装步骤</h2><ol>
<li>如果已安装 <code>ModTheSpire</code>，可跳至步骤 5。</li>
<li>从 <a target="_blank" rel="noopener" href="https://github.com/kiooeht/ModTheSpire/releases">此处</a> 下载 <code>ModTheSpire.jar</code></li>
<li>将 <code>ModTheSpire.jar</code> 移动至 <strong>杀戮尖塔</strong> 目录，路径示例：<br><code>C:\Program Files (x86)\Steam\steamapps\common\SlayTheSpire</code></li>
<li>在游戏目录中创建 <code>mods</code> 文件夹：<br><code>C:\Program Files (x86)\Steam\steamapps\common\SlayTheSpire\mods</code></li>
<li>从 <a target="_blank" rel="noopener" href="https://github.com/daviscook477/BaseMod/releases">此处</a> 下载 <code>BaseMod.jar</code></li>
<li>将 <code>BaseMod.jar</code> 放入 <code>mods</code> 文件夹</li>
<li>从 <a target="_blank" rel="noopener" href="https://github.com/gygrazok/witchmod/releases">此处</a> 下载 <code>WitchMod.jar</code></li>
<li>将 <code>WitchMod.jar</code> 同样放入 <code>mods</code> 文件夹</li>
<li>双击 <code>ModTheSpire.jar</code> 启动游戏</li>
<li>在模组选择界面勾选 <code>BaseMod</code> 和 <code>WitchMod</code>，点击 <strong>Play</strong> 开始游戏</li>
</ol>
<h1 id="鸣谢"><a href="#鸣谢" class="headerlink" title="鸣谢"></a>鸣谢</h1><ul>
<li>感谢 <a target="_blank" rel="noopener" href="https://www.megacrit.com/"><strong>杀戮尖塔</strong> 官方团队</a>，为我们提供了出色的游戏和模组支持。</li>
<li>感谢 <a target="_blank" rel="noopener" href="https://github.com/daviscook477">BaseMod</a> 的开发者 test447 及所有贡献者。</li>
<li>感谢 <a target="_blank" rel="noopener" href="https://github.com/kiooeht">ModTheSpire</a> 的开发者 kiooeht 及贡献者。</li>
<li>感谢所有提供 Bug 反馈、建议与平衡调整意见的玩家社区成员！</li>
</ul>
<h2 id="Github地址"><a href="#Github地址" class="headerlink" title="Github地址"></a>Github地址</h2><p><a target="_blank" rel="noopener" href="https://github.com/qingyun201908">Github</a><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/watchMOD/image_20250409192445.png" alt="alt text"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/09/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/PS%E5%AD%A6%E4%B9%A0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qing Yun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/09/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/PS%E5%AD%A6%E4%B9%A0/" class="post-title-link" itemprop="url">学习PS使用教程</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-09 23:32:53" itemprop="dateCreated datePublished" datetime="2025-04-09T23:32:53+00:00">2025-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-06 00:32:32" itemprop="dateModified" datetime="2025-06-06T00:32:32+00:00">2025-06-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="PS制作手机壁纸和电脑壁纸"><a href="#PS制作手机壁纸和电脑壁纸" class="headerlink" title="PS制作手机壁纸和电脑壁纸"></a>PS制作手机壁纸和电脑壁纸</h1><h2 id="1-思绪来源"><a href="#1-思绪来源" class="headerlink" title="1. 思绪来源"></a>1. 思绪来源</h2><p>找到了一位B站UP，分享了有关于灰原哀的动态壁纸。自身( •̀ ω •́ )也是名侦探柯南的爱好者，在此基础上，萌生了制作壁纸的想法。便在B站上搜寻有关于壁纸制作的教学。找到了一位壁纸分享者的教程<a target="_blank" rel="noopener" href="https://space.bilibili.com/38275995?spm_id_from=333.1387.follow.user_card.click">镜湾湾</a>在此基础上学习些许</p>
<h2 id="2-前期准备"><a href="#2-前期准备" class="headerlink" title="2. 前期准备"></a>2. 前期准备</h2><p>软件：<br>由于电脑是18年产物，故使用2018年版本的PS<br>素材:<br>个人是在pixiv中手动寻找素材，在github中有提供自动寻找的工具，但是个人使用不太理想。<br>自动化工具（）<a target="_blank" rel="noopener" href="https://github.com/xuejianxianzun/PixivBatchDownloader">自动化</a><br>部分素材如下：<br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/84425476_p2.jpg" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/110928966_p0_master1200.jpg" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/118226727_p2.jpg" alt="alt text"></p>
<h2 id="3-教学绘制过程"><a href="#3-教学绘制过程" class="headerlink" title="3. 教学绘制过程"></a>3. 教学绘制过程</h2><p>可去看对应的UP主视频</p>
<h2 id="4-成品如下"><a href="#4-成品如下" class="headerlink" title="4. 成品如下"></a>4. 成品如下</h2><p><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80-%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A97-1.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80--%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A91@1,5x.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80--%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A92_20250409180338.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80--%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A93_20250409180343.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80-%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A94-1_20250409180347.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80-%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A94-2.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80-%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A95-1.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80-%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A95-2.png" alt="alt text"><br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E7%81%B0%E5%8E%9F%E5%93%80-%E5%8A%A8%E6%BC%AB%E8%89%B2%E5%BD%A96-1.png" alt="alt text"></p>
<h2 id="5-附带产物"><a href="#5-附带产物" class="headerlink" title="5.附带产物"></a>5.附带产物</h2><p>帮忙做的高考志愿报名<br><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/PS%E5%AD%A6%E4%B9%A0/%E9%AB%98%E8%80%83%E5%BF%97%E6%84%BF.png" alt="alt text"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/04/09/%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7/AI%E5%A4%84%E7%90%86%E6%BC%AB%E7%94%BB%E8%BD%AC%E8%A7%86%E9%A2%91/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qing Yun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/04/09/%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7/AI%E5%A4%84%E7%90%86%E6%BC%AB%E7%94%BB%E8%BD%AC%E8%A7%86%E9%A2%91/" class="post-title-link" itemprop="url">AI处理漫画转视频</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-04-09 23:32:53" itemprop="dateCreated datePublished" datetime="2025-04-09T23:32:53+00:00">2025-04-09</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-06 00:32:32" itemprop="dateModified" datetime="2025-06-06T00:32:32+00:00">2025-06-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>AI处理漫画转视频</p>
<p>第一步 从漫画PDF文件读取图片<br>第二部 图片信息剪裁<br>第三步 OCR识别处理图片，获取漫画对应的文本信息<br>第四步 运用阿里云通义大模型千文处理提取的文本信息更符合文本语言<br>第五步 运用FishVideo大模型将文本信息转变为对应的语音<br>第六步 图片转视频处理将图片与语音结合并添加转场<br>第七步 合并视频段</p>
<h1 id="从PDF文件读取图片"><a href="#从PDF文件读取图片" class="headerlink" title="从PDF文件读取图片"></a>从PDF文件读取图片</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fitz  <span class="comment"># PyMuPDF</span></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_images_from_pdf</span>(<span class="params">pdf_path, output_folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从PDF文件中提取所有图片并按顺序保存到指定文件夹</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    参数:</span></span><br><span class="line"><span class="string">        pdf_path (str): PDF文件路径</span></span><br><span class="line"><span class="string">        output_folder (str): 图片保存目录</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 创建输出目录</span></span><br><span class="line">    os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 打开PDF文件</span></span><br><span class="line">    doc = fitz.<span class="built_in">open</span>(pdf_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化图片计数器</span></span><br><span class="line">    image_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 遍历每一页</span></span><br><span class="line">    <span class="keyword">for</span> page_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(doc)):</span><br><span class="line">        page = doc.load_page(page_num)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 获取当前页所有图片列表</span></span><br><span class="line">        image_list = page.get_images(full=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 遍历当前页的图片</span></span><br><span class="line">        <span class="keyword">for</span> image_index, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(image_list, start=<span class="number">1</span>):</span><br><span class="line">            xref = img[<span class="number">0</span>]  <span class="comment"># 获取图片xref</span></span><br><span class="line">            base_image = doc.extract_image(xref)  <span class="comment"># 提取图片信息</span></span><br><span class="line">            image_data = base_image[<span class="string">&quot;image&quot;</span>]      <span class="comment"># 获取图片二进制数据</span></span><br><span class="line">            ext = base_image[<span class="string">&quot;ext&quot;</span>]               <span class="comment"># 获取图片扩展名</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 生成图片文件名</span></span><br><span class="line">            image_filename = <span class="string">f&quot;image_<span class="subst">&#123;image_count + <span class="number">1</span>&#125;</span>.<span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">            image_path = os.path.join(output_folder, image_filename)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 保存图片</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(image_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> img_file:</span><br><span class="line">                img_file.write(image_data)</span><br><span class="line">            </span><br><span class="line">            image_count += <span class="number">1</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;成功提取 <span class="subst">&#123;image_count&#125;</span> 张图片到目录: <span class="subst">&#123;output_folder&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 配置参数（根据实际情况修改）</span></span><br><span class="line">    pdf_file = <span class="string">&quot;D:\\BaiduNetdiskDownload\\一-人-之-下第051-100话.pdf&quot;</span>  <span class="comment"># PDF文件路径</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 自动生成输出文件夹路径（PDF文件名 + _images）</span></span><br><span class="line">    base_name = os.path.splitext(os.path.basename(pdf_file))[<span class="number">0</span>]  <span class="comment"># 去除扩展名</span></span><br><span class="line">    folder_name = <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>_images&quot;</span>  <span class="comment"># 生成文件夹名称</span></span><br><span class="line">    output_dir = os.path.join(os.path.dirname(pdf_file), folder_name)  <span class="comment"># 完整输出路径</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 执行提取</span></span><br><span class="line">    extract_images_from_pdf(pdf_file, output_dir)</span><br></pre></td></tr></table></figure>


<h3 id="代码解析"><a href="#代码解析" class="headerlink" title="代码解析"></a>代码解析</h3><p>这段代码的主要功能是从指定的PDF文件中提取所有图片，并将这些图片按顺序保存到指定的文件夹中。下面是代码的详细分析：</p>
<h4 id="导入库"><a href="#导入库" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> fitz  <span class="comment"># PyMuPDF</span></span><br><span class="line"><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>
<ul>
<li><code>fitz</code>是PyMuPDF库的一个模块，用于处理PDF文件，包括读取和提取内容。</li>
<li><code>os</code>模块用于文件和目录的操作。</li>
</ul>
<h4 id="提取函数"><a href="#提取函数" class="headerlink" title="提取函数"></a>提取函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">extract_images_from_pdf</span>(<span class="params">pdf_path, output_folder</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>定义一个名为<code>extract_images_from_pdf</code>的函数，接受两个参数：<code>pdf_path</code>表示PDF文件的路径，<code>output_folder</code>表示保存提取图片的文件夹。</li>
</ul>
<h5 id="创建输出目录"><a href="#创建输出目录" class="headerlink" title="创建输出目录"></a>创建输出目录</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>os.makedirs</code>创建保存图片的目录，<code>exist_ok=True</code>表示如果目录已存在则不抛出异常。</li>
</ul>
<h5 id="打开PDF文件"><a href="#打开PDF文件" class="headerlink" title="打开PDF文件"></a>打开PDF文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc = fitz.<span class="built_in">open</span>(pdf_path)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>fitz.open</code>打开PDF文件，并将其赋值给<code>doc</code>对象。</li>
</ul>
<h5 id="初始化计数器"><a href="#初始化计数器" class="headerlink" title="初始化计数器"></a>初始化计数器</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image_count = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>初始化<code>image_count</code>变量，用于统计提取的图片数量。</li>
</ul>
<h5 id="遍历每一页"><a href="#遍历每一页" class="headerlink" title="遍历每一页"></a>遍历每一页</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> page_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(doc)):</span><br><span class="line">    page = doc.load_page(page_num)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>for</code>循环遍历PDF的每一页，<code>doc.load_page(page_num)</code>加载当前页。</li>
</ul>
<h5 id="获取和处理图片"><a href="#获取和处理图片" class="headerlink" title="获取和处理图片"></a>获取和处理图片</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image_list = page.get_images(full=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>获取当前页的所有图片，并将其存储在<code>image_list</code>中。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> image_index, img <span class="keyword">in</span> <span class="built_in">enumerate</span>(image_list, start=<span class="number">1</span>):</span><br><span class="line">    xref = img[<span class="number">0</span>]  <span class="comment"># 获取图片xref</span></span><br><span class="line">    base_image = doc.extract_image(xref)  <span class="comment"># 提取图片信息</span></span><br><span class="line">    image_data = base_image[<span class="string">&quot;image&quot;</span>]      <span class="comment"># 获取图片二进制数据</span></span><br><span class="line">    ext = base_image[<span class="string">&quot;ext&quot;</span>]               <span class="comment"># 获取图片扩展名</span></span><br></pre></td></tr></table></figure>
<ul>
<li>对于每个图片，提取图片的引用（xref），然后获取其详细信息，包括二进制数据和扩展名。</li>
</ul>
<h5 id="保存图片"><a href="#保存图片" class="headerlink" title="保存图片"></a>保存图片</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">image_filename = <span class="string">f&quot;image_<span class="subst">&#123;image_count + <span class="number">1</span>&#125;</span>.<span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">image_path = os.path.join(output_folder, image_filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(image_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> img_file:</span><br><span class="line">    img_file.write(image_data)</span><br><span class="line"></span><br><span class="line">image_count += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>生成图片文件名，构造完整的文件路径，并使用<code>with open</code>将图片数据写入文件。</li>
</ul>
<h5 id="提示成功信息"><a href="#提示成功信息" class="headerlink" title="提示成功信息"></a>提示成功信息</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;成功提取 <span class="subst">&#123;image_count&#125;</span> 张图片到目录: <span class="subst">&#123;output_folder&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>在控制台输出提取成功的图片数量及其保存路径。</li>
</ul>
<h4 id="主程序块"><a href="#主程序块" class="headerlink" title="主程序块"></a>主程序块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>仅当该脚本作为主程序运行时，以下代码才会执行。</li>
</ul>
<h5 id="配置参数"><a href="#配置参数" class="headerlink" title="配置参数"></a>配置参数</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pdf_file = <span class="string">&quot;D:\\BaiduNetdiskDownload\\一-人-之-下第051-100话.pdf&quot;</span>  <span class="comment"># PDF文件路径</span></span><br></pre></td></tr></table></figure>
<ul>
<li>设置要提取图片的PDF文件路径。</li>
</ul>
<h5 id="自动生成输出文件夹路径"><a href="#自动生成输出文件夹路径" class="headerlink" title="自动生成输出文件夹路径"></a>自动生成输出文件夹路径</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">base_name = os.path.splitext(os.path.basename(pdf_file))[<span class="number">0</span>]</span><br><span class="line">folder_name = <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>_images&quot;</span></span><br><span class="line">output_dir = os.path.join(os.path.dirname(pdf_file), folder_name)</span><br></pre></td></tr></table></figure>
<ul>
<li>自动生成输出文件夹的名称，格式为<code>PDF文件名_images</code>。</li>
</ul>
<h5 id="执行提取"><a href="#执行提取" class="headerlink" title="执行提取"></a>执行提取</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extract_images_from_pdf(pdf_file, output_dir)</span><br></pre></td></tr></table></figure>
<ul>
<li>调用提取函数，开始提取图片。</li>
</ul>
<h3 id="Markdown-文件内容"><a href="#Markdown-文件内容" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 从PDF提取图片的Python脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本用于从指定的PDF文件中提取所有图片并将其按顺序保存到指定的文件夹中。使用了<span class="code">`fitz`</span>库（PyMuPDF）来处理PDF文件。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">import fitz  # PyMuPDF</span></span><br><span class="line"><span class="code">import os</span></span><br></pre></td></tr></table></figure>

<h3 id="提取函数-1"><a href="#提取函数-1" class="headerlink" title="提取函数"></a>提取函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">extract_images_from_pdf</span>(<span class="params">pdf_path, output_folder</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>参数</strong>:<ul>
<li><code>pdf_path</code>: PDF文件的路径。</li>
<li><code>output_folder</code>: 存储提取图片的文件夹路径。</li>
</ul>
</li>
</ul>
<h3 id="创建输出目录-1"><a href="#创建输出目录-1" class="headerlink" title="创建输出目录"></a>创建输出目录</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="打开PDF文件-1"><a href="#打开PDF文件-1" class="headerlink" title="打开PDF文件"></a>打开PDF文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">doc = fitz.<span class="built_in">open</span>(pdf_path)</span><br></pre></td></tr></table></figure>

<h3 id="初始化计数器-1"><a href="#初始化计数器-1" class="headerlink" title="初始化计数器"></a>初始化计数器</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image_count = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h3 id="遍历每一页-1"><a href="#遍历每一页-1" class="headerlink" title="遍历每一页"></a>遍历每一页</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> page_num <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(doc)):</span><br><span class="line">    page = doc.load_page(page_num)</span><br></pre></td></tr></table></figure>

<h3 id="获取和处理图片-1"><a href="#获取和处理图片-1" class="headerlink" title="获取和处理图片"></a>获取和处理图片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">image_list = page.get_images(full=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h3 id="保存图片-1"><a href="#保存图片-1" class="headerlink" title="保存图片"></a>保存图片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">image_filename = <span class="string">f&quot;image_<span class="subst">&#123;image_count + <span class="number">1</span>&#125;</span>.<span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">image_path = os.path.join(output_folder, image_filename)</span><br><span class="line"></span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(image_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> img_file:</span><br><span class="line">    img_file.write(image_data)</span><br><span class="line"></span><br><span class="line">image_count += <span class="number">1</span></span><br></pre></td></tr></table></figure>

<h3 id="提示成功信息-1"><a href="#提示成功信息-1" class="headerlink" title="提示成功信息"></a>提示成功信息</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;成功提取 <span class="subst">&#123;image_count&#125;</span> 张图片到目录: <span class="subst">&#123;output_folder&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="主程序块-1"><a href="#主程序块-1" class="headerlink" title="主程序块"></a>主程序块</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>配置PDF文件路径和输出文件夹。</li>
</ul>
<h2 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>安装PyMuPDF库：<code>pip install PyMuPDF</code>。</li>
<li>修改<code>pdf_file</code>变量为要提取的PDF文件路径。</li>
<li>运行脚本，提取的图片将存储在指定的文件夹中。</li>
</ol>
<h2 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保PDF文件路径正确。</li>
<li>输出文件夹将自动创建，若已存在则会被忽略。</li>
</ul>
<h1 id="图片信息剪裁"><a href="#图片信息剪裁" class="headerlink" title="图片信息剪裁"></a>图片信息剪裁</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">batch_crop_images</span>(<span class="params">input_folder, output_folder, top, bottom</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    批量裁剪图片（仅修改下边界，保持左右宽度不变）</span></span><br><span class="line"><span class="string">    :param input_folder: 输入文件夹路径</span></span><br><span class="line"><span class="string">    :param output_folder: 输出文件夹路径</span></span><br><span class="line"><span class="string">    :param top: 裁剪区域上边界</span></span><br><span class="line"><span class="string">    :param bottom: 裁剪区域下边界</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 确保输出文件夹存在</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_folder):</span><br><span class="line">        os.makedirs(output_folder)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 遍历输入文件夹中的所有文件</span></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_folder):</span><br><span class="line">        <span class="keyword">if</span> filename.lower().endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>)):</span><br><span class="line">            image_path = os.path.join(input_folder, filename)</span><br><span class="line">            <span class="keyword">with</span> Image.<span class="built_in">open</span>(image_path) <span class="keyword">as</span> img:</span><br><span class="line">                width, height = img.size</span><br><span class="line">                <span class="comment"># 保持左右不变（left=0, right=图片宽度）</span></span><br><span class="line">                <span class="comment"># 动态调整下边界，确保不超过图片高度</span></span><br><span class="line">                adjusted_bottom = <span class="built_in">min</span>(bottom, height)</span><br><span class="line">                <span class="comment"># 裁剪区域：左=0, 上=top, 右=width, 下=adjusted_bottom</span></span><br><span class="line">                cropped_img = img.crop((<span class="number">0</span>, top, width, adjusted_bottom))</span><br><span class="line">                output_path = os.path.join(output_folder, filename)</span><br><span class="line">                cropped_img.save(output_path)</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;裁剪并保存: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例调用</span></span><br><span class="line">input_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\051-100_images&quot;</span></span><br><span class="line">output_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\051-100_images2&quot;</span></span><br><span class="line">top, bottom = <span class="number">0</span>, <span class="number">1225</span>  <span class="comment"># 仅设置上边界和下边界</span></span><br><span class="line"></span><br><span class="line">batch_crop_images(input_folder, output_folder, top, bottom)</span><br></pre></td></tr></table></figure>

<h3 id="代码解析-1"><a href="#代码解析-1" class="headerlink" title="代码解析"></a>代码解析</h3><p>该代码的主要功能是批量裁剪指定文件夹中的图片，保持左右宽度不变，只调整上下边界。裁剪后的图片将保存到指定的输出文件夹中。以下是代码的详细分析：</p>
<h4 id="导入库-1"><a href="#导入库-1" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> PIL <span class="keyword">import</span> Image</span><br><span class="line"><span class="keyword">import</span> os</span><br></pre></td></tr></table></figure>
<ul>
<li><code>PIL</code>（Python Imaging Library）: 用于图像处理，主要用于打开、操作和保存图像文件。</li>
<li><code>os</code>: 用于与操作系统交互，进行文件和目录操作。</li>
</ul>
<h4 id="批量裁剪函数"><a href="#批量裁剪函数" class="headerlink" title="批量裁剪函数"></a>批量裁剪函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">batch_crop_images</span>(<span class="params">input_folder, output_folder, top, bottom</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数接受四个参数：<ul>
<li><code>input_folder</code>: 输入文件夹路径，包含待裁剪的图片。</li>
<li><code>output_folder</code>: 输出文件夹路径，保存裁剪后的图片。</li>
<li><code>top</code>: 裁剪区域的上边界。</li>
<li><code>bottom</code>: 裁剪区域的下边界。</li>
</ul>
</li>
</ul>
<h5 id="确保输出文件夹存在"><a href="#确保输出文件夹存在" class="headerlink" title="确保输出文件夹存在"></a>确保输出文件夹存在</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_folder):</span><br><span class="line">    os.makedirs(output_folder)</span><br></pre></td></tr></table></figure>
<ul>
<li>检查输出文件夹是否存在，如果不存在则创建该文件夹。</li>
</ul>
<h5 id="遍历输入文件夹中的所有文件"><a href="#遍历输入文件夹中的所有文件" class="headerlink" title="遍历输入文件夹中的所有文件"></a>遍历输入文件夹中的所有文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_folder):</span><br><span class="line">    <span class="keyword">if</span> filename.lower().endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>)):</span><br></pre></td></tr></table></figure>
<ul>
<li>遍历输入文件夹中的所有文件，并筛选出支持的图片格式（.png, .jpg, .jpeg, .bmp, .gif）。</li>
</ul>
<h5 id="打开和裁剪图片"><a href="#打开和裁剪图片" class="headerlink" title="打开和裁剪图片"></a>打开和裁剪图片</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image_path = os.path.join(input_folder, filename)</span><br><span class="line"><span class="keyword">with</span> Image.<span class="built_in">open</span>(image_path) <span class="keyword">as</span> img:</span><br><span class="line">    width, height = img.size</span><br></pre></td></tr></table></figure>
<ul>
<li>构造每个图片的完整路径，使用<code>Image.open()</code>打开图片，并获取其宽度和高度。</li>
</ul>
<h6 id="动态调整裁剪区域"><a href="#动态调整裁剪区域" class="headerlink" title="动态调整裁剪区域"></a>动态调整裁剪区域</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adjusted_bottom = <span class="built_in">min</span>(bottom, height)</span><br></pre></td></tr></table></figure>
<ul>
<li>确保下边界不超过图片的实际高度，避免裁剪超出图片范围。</li>
</ul>
<h6 id="裁剪并保存图片"><a href="#裁剪并保存图片" class="headerlink" title="裁剪并保存图片"></a>裁剪并保存图片</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cropped_img = img.crop((<span class="number">0</span>, top, width, adjusted_bottom))</span><br><span class="line">output_path = os.path.join(output_folder, filename)</span><br><span class="line">cropped_img.save(output_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;裁剪并保存: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>crop()</code>方法进行裁剪，裁剪区域为左&#x3D;0，上&#x3D;top，右&#x3D;width，下&#x3D;adjusted_bottom。裁剪后的图片保存到输出路径，并打印保存消息。</li>
</ul>
<h3 id="示例调用"><a href="#示例调用" class="headerlink" title="示例调用"></a>示例调用</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\051-100_images&quot;</span></span><br><span class="line">output_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\051-100_images2&quot;</span></span><br><span class="line">top, bottom = <span class="number">0</span>, <span class="number">1225</span>  <span class="comment"># 仅设置上边界和下边界</span></span><br><span class="line"></span><br><span class="line">batch_crop_images(input_folder, output_folder, top, bottom)</span><br></pre></td></tr></table></figure>
<ul>
<li>指定输入文件夹、输出文件夹及裁剪的上下边界，然后调用<code>batch_crop_images</code>函数进行批量裁剪操作。</li>
</ul>
<h3 id="Markdown-文件内容-1"><a href="#Markdown-文件内容-1" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 批量裁剪图片脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本用于批量裁剪指定文件夹中的图片，裁剪区域的上下边界可由用户自定义，保持左右宽度不变。裁剪后的图片将保存到指定的输出文件夹中。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">from PIL import Image</span></span><br><span class="line"><span class="code">import os</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>PIL</code>: 用于图像处理。</li>
<li><code>os</code>: 用于文件和目录操作。</li>
</ul>
<h3 id="批量裁剪函数-1"><a href="#批量裁剪函数-1" class="headerlink" title="批量裁剪函数"></a>批量裁剪函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">batch_crop_images</span>(<span class="params">input_folder, output_folder, top, bottom</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>函数接受输入文件夹路径、输出文件夹路径、上边界和下边界。</li>
</ul>
<h4 id="确保输出文件夹存在-1"><a href="#确保输出文件夹存在-1" class="headerlink" title="确保输出文件夹存在"></a>确保输出文件夹存在</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(output_folder):</span><br><span class="line">    os.makedirs(output_folder)</span><br></pre></td></tr></table></figure>

<h4 id="遍历输入文件夹中的所有文件-1"><a href="#遍历输入文件夹中的所有文件-1" class="headerlink" title="遍历输入文件夹中的所有文件"></a>遍历输入文件夹中的所有文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_folder):</span><br><span class="line">    <span class="keyword">if</span> filename.lower().endswith((<span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>)):</span><br></pre></td></tr></table></figure>

<h4 id="打开和裁剪图片-1"><a href="#打开和裁剪图片-1" class="headerlink" title="打开和裁剪图片"></a>打开和裁剪图片</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image_path = os.path.join(input_folder, filename)</span><br><span class="line"><span class="keyword">with</span> Image.<span class="built_in">open</span>(image_path) <span class="keyword">as</span> img:</span><br><span class="line">    width, height = img.size</span><br></pre></td></tr></table></figure>

<h4 id="动态调整裁剪区域-1"><a href="#动态调整裁剪区域-1" class="headerlink" title="动态调整裁剪区域"></a>动态调整裁剪区域</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adjusted_bottom = <span class="built_in">min</span>(bottom, height)</span><br></pre></td></tr></table></figure>

<h4 id="裁剪并保存图片-1"><a href="#裁剪并保存图片-1" class="headerlink" title="裁剪并保存图片"></a>裁剪并保存图片</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cropped_img = img.crop((<span class="number">0</span>, top, width, adjusted_bottom))</span><br><span class="line">output_path = os.path.join(output_folder, filename)</span><br><span class="line">cropped_img.save(output_path)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;裁剪并保存: <span class="subst">&#123;output_path&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="示例调用-1"><a href="#示例调用-1" class="headerlink" title="示例调用"></a>示例调用</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">input_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\051-100_images&quot;</span></span><br><span class="line">output_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\051-100_images2&quot;</span></span><br><span class="line">top, bottom = <span class="number">0</span>, <span class="number">1225</span>  <span class="comment"># 仅设置上边界和下边界</span></span><br><span class="line"></span><br><span class="line">batch_crop_images(input_folder, output_folder, top, bottom)</span><br></pre></td></tr></table></figure>

<h2 id="使用说明-1"><a href="#使用说明-1" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>确保已安装Pillow库（可以使用<code>pip install Pillow</code>）。</li>
<li>指定输入文件夹和输出文件夹路径。</li>
<li>调整上边界和下边界参数。</li>
<li>运行脚本，裁剪后的图片将保存到输出文件夹中。</li>
</ol>
<h2 id="注意事项-1"><a href="#注意事项-1" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保输入文件夹中存在支持的图片格式。</li>
<li>裁剪区域的上边界和下边界应确保合理，以避免裁剪超出图片范围。</li>
</ul>
<h1 id="OCR识别处理图片，获取漫画对应的文本信息"><a href="#OCR识别处理图片，获取漫画对应的文本信息" class="headerlink" title="OCR识别处理图片，获取漫画对应的文本信息"></a>OCR识别处理图片，获取漫画对应的文本信息</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> easyocr</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> gc <span class="keyword">import</span> collect  <span class="comment"># 内存回收</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ------------------- 配置区域 -------------------</span></span><br><span class="line">input_folder = <span class="string">r&#x27;D:\BaiduNetdiskDownload\051-100_images2&#x27;</span></span><br><span class="line">languages = [<span class="string">&#x27;ch_sim&#x27;</span>, <span class="string">&#x27;en&#x27;</span>]</span><br><span class="line">supported_exts = [<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>]</span><br><span class="line"><span class="comment"># ----------------------------------------------</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># GTX 1050Ti 优化参数</span></span><br><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&#x27;batch_size&#x27;</span>: <span class="number">4</span>,           <span class="comment"># 显存有限，建议4-6</span></span><br><span class="line">    <span class="string">&#x27;workers&#x27;</span>: <span class="number">2</span>,              <span class="comment"># 避免过多线程竞争</span></span><br><span class="line">    <span class="string">&#x27;fp16&#x27;</span>: <span class="literal">False</span>,             <span class="comment"># 1050Ti不支持Tensor Core，关闭半精度</span></span><br><span class="line">    <span class="string">&#x27;model_load&#x27;</span>: <span class="string">&#x27;balanced&#x27;</span>   <span class="comment"># 显存优化模式</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_paragraphs</span>(<span class="params">results</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;轻量级段落合并算法&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> results:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 按Y坐标排序</span></span><br><span class="line">    sorted_results = <span class="built_in">sorted</span>(results, key=<span class="keyword">lambda</span> x: x[<span class="number">0</span>][<span class="number">0</span>][<span class="number">1</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 合并逻辑（简化版）</span></span><br><span class="line">    paragraphs = []</span><br><span class="line">    current_para = []</span><br><span class="line">    prev_bottom = -<span class="number">100</span>  <span class="comment"># 初始间距</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> box, text, _ <span class="keyword">in</span> sorted_results:</span><br><span class="line">        top = box[<span class="number">0</span>][<span class="number">1</span>]</span><br><span class="line">        <span class="comment"># 行间距超过50像素视为新段落（根据漫画排版调整）</span></span><br><span class="line">        <span class="keyword">if</span> (top - prev_bottom) &gt; <span class="number">50</span>:</span><br><span class="line">            <span class="keyword">if</span> current_para:</span><br><span class="line">                paragraphs.append(<span class="string">&#x27; &#x27;</span>.join(current_para))</span><br><span class="line">                current_para = []</span><br><span class="line">        current_para.append(text.strip())</span><br><span class="line">        prev_bottom = box[<span class="number">3</span>][<span class="number">1</span>]  <span class="comment"># 更新底部坐标</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> current_para:</span><br><span class="line">        paragraphs.append(<span class="string">&#x27; &#x27;</span>.join(current_para))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> paragraphs</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_image</span>(<span class="params">reader, image_path, output_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理单张图片并管理显存&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="comment"># 读取图片</span></span><br><span class="line">        img = cv2.imread(image_path)</span><br><span class="line">        <span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">            <span class="keyword">raise</span> ValueError(<span class="string">&quot;图片读取失败&quot;</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 显存优化策略</span></span><br><span class="line">        torch.cuda.empty_cache()</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 执行OCR</span></span><br><span class="line">        results = reader.readtext(</span><br><span class="line">            img,</span><br><span class="line">            batch_size=config[<span class="string">&#x27;batch_size&#x27;</span>],</span><br><span class="line">            workers=config[<span class="string">&#x27;workers&#x27;</span>],</span><br><span class="line">            detail=<span class="number">1</span>,          <span class="comment"># 必须为1才能获取坐标</span></span><br><span class="line">            paragraph=<span class="literal">False</span>    <span class="comment"># 禁用内置段落合并（使用自定义算法）</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 合并段落</span></span><br><span class="line">        paragraphs = merge_paragraphs(results)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 保存结果</span></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            f.write(<span class="string">&#x27;\n&#x27;</span>.join(paragraphs))</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        collect()  <span class="comment"># 强制回收内存</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 验证CUDA</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> torch.cuda.is_available():</span><br><span class="line">        <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;CUDA不可用，请检查驱动&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 初始化Reader（显存优化配置）</span></span><br><span class="line">    reader = easyocr.Reader(</span><br><span class="line">        lang_list=languages,</span><br><span class="line">        gpu=<span class="literal">True</span>,</span><br><span class="line">        detector=<span class="literal">True</span>,</span><br><span class="line">        recognizer=<span class="literal">True</span>,</span><br><span class="line">        model_storage_directory=<span class="literal">None</span>,</span><br><span class="line">        download_enabled=<span class="literal">False</span>,</span><br><span class="line">        user_network_directory=<span class="literal">None</span></span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 遍历处理</span></span><br><span class="line">    total = <span class="built_in">len</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(input_folder) <span class="keyword">if</span> <span class="built_in">any</span>(f.endswith(ext) <span class="keyword">for</span> ext <span class="keyword">in</span> supported_exts)])</span><br><span class="line">    processed = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_folder):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">any</span>(filename.lower().endswith(ext) <span class="keyword">for</span> ext <span class="keyword">in</span> supported_exts):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">        </span><br><span class="line">        image_path = os.path.join(input_folder, filename)</span><br><span class="line">        output_path = os.path.join(</span><br><span class="line">            input_folder,</span><br><span class="line">            <span class="string">f&quot;<span class="subst">&#123;os.path.splitext(filename)[<span class="number">0</span>]&#125;</span>.txt&quot;</span></span><br><span class="line">        )</span><br><span class="line">        </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理中 [<span class="subst">&#123;processed+<span class="number">1</span>&#125;</span>\&#123;total&#125;]: <span class="subst">&#123;filename[:<span class="number">20</span>]&#125;</span>...&quot;</span>, end=<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> process_image(reader, image_path, output_path):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot; ✓&quot;</span>)</span><br><span class="line">            processed += <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot; ✗&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n完成！成功处理 <span class="subst">&#123;processed&#125;</span>\&#123;total&#125; 张图片&quot;</span>)  </span><br></pre></td></tr></table></figure>

<h3 id="代码解析-2"><a href="#代码解析-2" class="headerlink" title="代码解析"></a>代码解析</h3><p>该代码的主要功能是使用EasyOCR库从指定文件夹中的图片中提取文本，并将提取的文本保存到相应的文本文件中。使用了OpenCV库来读取图像，并且通过PyTorch对GPU进行优化。以下是代码的详细分析：</p>
<h4 id="导入库-2"><a href="#导入库-2" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> easyocr</span><br><span class="line"><span class="keyword">import</span> cv2</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> torch</span><br><span class="line"><span class="keyword">from</span> gc <span class="keyword">import</span> collect  <span class="comment"># 内存回收</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>easyocr</code>: 用于图像文本识别（OCR）。</li>
<li><code>cv2</code>: OpenCV库，用于图像处理。</li>
<li><code>os</code>: 用于文件和目录操作。</li>
<li><code>torch</code>: PyTorch库，用于深度学习相关操作。</li>
<li><code>collect</code>: 从<code>gc</code>模块中导入，用于强制内存回收。</li>
</ul>
<h4 id="配置区域"><a href="#配置区域" class="headerlink" title="配置区域"></a>配置区域</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input_folder = <span class="string">r&#x27;D:\BaiduNetdiskDownload\051-100_images2&#x27;</span></span><br><span class="line">languages = [<span class="string">&#x27;ch_sim&#x27;</span>, <span class="string">&#x27;en&#x27;</span>]</span><br><span class="line">supported_exts = [<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li><code>input_folder</code>: 输入图片的文件夹路径。</li>
<li><code>languages</code>: 指定OCR识别的语言，这里包括简体中文和英语。</li>
<li><code>supported_exts</code>: 支持的图片扩展名列表。</li>
</ul>
<h4 id="GPU优化参数"><a href="#GPU优化参数" class="headerlink" title="GPU优化参数"></a>GPU优化参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&#x27;batch_size&#x27;</span>: <span class="number">4</span>,           </span><br><span class="line">    <span class="string">&#x27;workers&#x27;</span>: <span class="number">2</span>,              </span><br><span class="line">    <span class="string">&#x27;fp16&#x27;</span>: <span class="literal">False</span>,             </span><br><span class="line">    <span class="string">&#x27;model_load&#x27;</span>: <span class="string">&#x27;balanced&#x27;</span>   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li><code>batch_size</code>: 设置为4以适应显存限制。</li>
<li><code>workers</code>: 工作线程数，避免过多线程竞争。</li>
<li><code>fp16</code>: 由于GTX 1050Ti不支持Tensor Core，设置为False以关闭半精度。</li>
<li><code>model_load</code>: 使用平衡模式优化显存使用。</li>
</ul>
<h4 id="段落合并函数"><a href="#段落合并函数" class="headerlink" title="段落合并函数"></a>段落合并函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_paragraphs</span>(<span class="params">results</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数负责将OCR识别的文本结果进行段落合并，以便更好地处理文本输出。</li>
</ul>
<h5 id="合并逻辑"><a href="#合并逻辑" class="headerlink" title="合并逻辑"></a>合并逻辑</h5><ul>
<li>按Y坐标排序，并根据行间距（超过50像素视为新段落）将文本合并。</li>
</ul>
<h4 id="图像处理函数"><a href="#图像处理函数" class="headerlink" title="图像处理函数"></a>图像处理函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_image</span>(<span class="params">reader, image_path, output_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>处理单张图片并管理显存，读取图片，执行OCR，合并段落并保存结果。</li>
</ul>
<h5 id="读取和检查图片"><a href="#读取和检查图片" class="headerlink" title="读取和检查图片"></a>读取和检查图片</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">img = cv2.imread(image_path)</span><br><span class="line"><span class="keyword">if</span> img <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">    <span class="keyword">raise</span> ValueError(<span class="string">&quot;图片读取失败&quot;</span>)</span><br></pre></td></tr></table></figure>

<h5 id="执行OCR"><a href="#执行OCR" class="headerlink" title="执行OCR"></a>执行OCR</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">results = reader.readtext(</span><br><span class="line">    img,</span><br><span class="line">    batch_size=config[<span class="string">&#x27;batch_size&#x27;</span>],</span><br><span class="line">    workers=config[<span class="string">&#x27;workers&#x27;</span>],</span><br><span class="line">    detail=<span class="number">1</span>,</span><br><span class="line">    paragraph=<span class="literal">False</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用EasyOCR的<code>readtext</code>方法提取文本，设置详细级别为1以获取坐标。</li>
</ul>
<h5 id="保存结果"><a href="#保存结果" class="headerlink" title="保存结果"></a>保存结果</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(output_path, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    f.write(<span class="string">&#x27;\n&#x27;</span>.join(paragraphs))</span><br></pre></td></tr></table></figure>

<h5 id="内存回收"><a href="#内存回收" class="headerlink" title="内存回收"></a>内存回收</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">finally</span>:</span><br><span class="line">    collect()  <span class="comment"># 强制回收内存</span></span><br></pre></td></tr></table></figure>

<h4 id="主程序块-2"><a href="#主程序块-2" class="headerlink" title="主程序块"></a>主程序块</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>确保该代码块仅在脚本作为主程序运行时执行。</li>
</ul>
<h5 id="验证CUDA"><a href="#验证CUDA" class="headerlink" title="验证CUDA"></a>验证CUDA</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> torch.cuda.is_available():</span><br><span class="line">    <span class="keyword">raise</span> RuntimeError(<span class="string">&quot;CUDA不可用，请检查驱动&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>检查CUDA是否可用，以确保可以使用GPU进行加速。</li>
</ul>
<h5 id="初始化Reader"><a href="#初始化Reader" class="headerlink" title="初始化Reader"></a>初始化Reader</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">reader = easyocr.Reader(</span><br><span class="line">    lang_list=languages,</span><br><span class="line">    gpu=<span class="literal">True</span>,</span><br><span class="line">    detector=<span class="literal">True</span>,</span><br><span class="line">    recognizer=<span class="literal">True</span>,</span><br><span class="line">    model_storage_directory=<span class="literal">None</span>,</span><br><span class="line">    download_enabled=<span class="literal">False</span>,</span><br><span class="line">    user_network_directory=<span class="literal">None</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化EasyOCR的Reader对象，配置使用GPU。</li>
</ul>
<h5 id="遍历处理图片"><a href="#遍历处理图片" class="headerlink" title="遍历处理图片"></a>遍历处理图片</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">total = <span class="built_in">len</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(input_folder) <span class="keyword">if</span> <span class="built_in">any</span>(f.endswith(ext) <span class="keyword">for</span> ext <span class="keyword">in</span> supported_exts)])</span><br></pre></td></tr></table></figure>
<ul>
<li>统计输入文件夹中支持的图片数量。</li>
</ul>
<h5 id="处理每张图片"><a href="#处理每张图片" class="headerlink" title="处理每张图片"></a>处理每张图片</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(input_folder):</span><br></pre></td></tr></table></figure>
<ul>
<li>遍历输入文件夹中的每个文件，检查扩展名并调用<code>process_image</code>处理。</li>
</ul>
<h5 id="打印处理状态"><a href="#打印处理状态" class="headerlink" title="打印处理状态"></a>打印处理状态</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;处理中 [<span class="subst">&#123;processed+<span class="number">1</span>&#125;</span>\&#123;total&#125;]: <span class="subst">&#123;filename[:<span class="number">20</span>]&#125;</span>...&quot;</span>, end=<span class="string">&#x27;&#x27;</span>, flush=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>输出当前处理进度。</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n完成！成功处理 <span class="subst">&#123;processed&#125;</span>\&#123;total&#125; 张图片&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>最后输出处理结果。</li>
</ul>
<h3 id="Markdown-文件内容-2"><a href="#Markdown-文件内容-2" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 使用EasyOCR从图片中提取文本的Python脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本通过EasyOCR库从指定文件夹中的图片中提取文本，并将提取的文本保存到相应的文本文件中。使用OpenCV库读取图像，并通过PyTorch对GPU进行优化。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">import easyocr</span></span><br><span class="line"><span class="code">import cv2</span></span><br><span class="line"><span class="code">import os</span></span><br><span class="line"><span class="code">import torch</span></span><br><span class="line"><span class="code">from gc import collect  # 内存回收</span></span><br></pre></td></tr></table></figure>

<h3 id="配置区域-1"><a href="#配置区域-1" class="headerlink" title="配置区域"></a>配置区域</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input_folder = <span class="string">r&#x27;D:\BaiduNetdiskDownload\051-100_images2&#x27;</span></span><br><span class="line">languages = [<span class="string">&#x27;ch_sim&#x27;</span>, <span class="string">&#x27;en&#x27;</span>]</span><br><span class="line">supported_exts = [<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="GPU优化参数-1"><a href="#GPU优化参数-1" class="headerlink" title="GPU优化参数"></a>GPU优化参数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">config = &#123;</span><br><span class="line">    <span class="string">&#x27;batch_size&#x27;</span>: <span class="number">4</span>,           </span><br><span class="line">    <span class="string">&#x27;workers&#x27;</span>: <span class="number">2</span>,              </span><br><span class="line">    <span class="string">&#x27;fp16&#x27;</span>: <span class="literal">False</span>,             </span><br><span class="line">    <span class="string">&#x27;model_load&#x27;</span>: <span class="string">&#x27;balanced&#x27;</span>   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="段落合并函数-1"><a href="#段落合并函数-1" class="headerlink" title="段落合并函数"></a>段落合并函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_paragraphs</span>(<span class="params">results</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>合并OCR结果中的段落，以提高可读性。</li>
</ul>
<h3 id="图像处理函数-1"><a href="#图像处理函数-1" class="headerlink" title="图像处理函数"></a>图像处理函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_image</span>(<span class="params">reader, image_path, output_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>读取图片，执行OCR，合并段落并保存结果。</li>
</ul>
<h3 id="主程序块-3"><a href="#主程序块-3" class="headerlink" title="主程序块"></a>主程序块</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>检查CUDA是否可用，并初始化EasyOCR的Reader对象。</li>
</ul>
<h3 id="遍历处理图片-1"><a href="#遍历处理图片-1" class="headerlink" title="遍历处理图片"></a>遍历处理图片</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">total = <span class="built_in">len</span>([f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(input_folder) <span class="keyword">if</span> <span class="built_in">any</span>(f.endswith(ext) <span class="keyword">for</span> ext <span class="keyword">in</span> supported_exts)])</span><br></pre></td></tr></table></figure>
<ul>
<li>统计待处理的图片数量，逐一处理并输出处理进度。</li>
</ul>
<h2 id="使用说明-2"><a href="#使用说明-2" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>安装必要的库：<code>pip install easyocr opencv-python torch</code>。</li>
<li>修改<code>input_folder</code>为要处理的图片文件夹路径。</li>
<li>运行脚本，提取的文本将保存为相应的<code>.txt</code>文件。</li>
</ol>
<h2 id="注意事项-2"><a href="#注意事项-2" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保安装了支持CUDA的PyTorch版本。</li>
<li>确保输入文件夹中存在支持的图片格式。</li>
</ul>
<h1 id="运用阿里云通义千文处理提取的文本信息更符合文本语言"><a href="#运用阿里云通义千文处理提取的文本信息更符合文本语言" class="headerlink" title="运用阿里云通义千文处理提取的文本信息更符合文本语言"></a>运用阿里云通义千文处理提取的文本信息更符合文本语言</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> openpyxl</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化OpenAI客户端</span></span><br><span class="line">client = OpenAI(</span><br><span class="line">    api_key=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;https:\\dashscope.aliyuncs.com\compatible-mode\v1&quot;</span>,</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化Excel文件</span></span><br><span class="line">excel_file = <span class="string">&quot;D:\\text_processing_log.xlsx&quot;</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(excel_file):</span><br><span class="line">    wb = openpyxl.load_workbook(excel_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    wb = openpyxl.Workbook()</span><br><span class="line">ws = wb.active</span><br><span class="line">ws.title = <span class="string">&quot;处理记录&quot;</span></span><br><span class="line"><span class="keyword">if</span> ws.max_row == <span class="number">1</span>:</span><br><span class="line">    ws.append([<span class="string">&quot;类型&quot;</span>, <span class="string">&quot;内容&quot;</span>, <span class="string">&quot;文件路径&quot;</span>, <span class="string">&quot;处理时间&quot;</span>])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">save_to_excel</span>(<span class="params">question, answer, file_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;保存到Excel文件&quot;&quot;&quot;</span></span><br><span class="line">    timestamp = datetime.datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    ws.append([<span class="string">&quot;问题&quot;</span>, question, file_path, timestamp])</span><br><span class="line">    ws.append([<span class="string">&quot;回答&quot;</span>, answer, file_path, timestamp])</span><br><span class="line">    wb.save(excel_file)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_dialog</span>(<span class="params">question, answer, max_width=<span class="number">80</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;在CMD界面美观打印对话&quot;&quot;&quot;</span></span><br><span class="line">    sep_line = <span class="string">&#x27;─&#x27;</span> * max_width</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n<span class="subst">&#123;sep_line&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 问题 &quot;</span>.center(max_width, <span class="string">&#x27;░&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;question&#125;</span>\n&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot; 回答 &quot;</span>.center(max_width, <span class="string">&#x27;░&#x27;</span>))</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;<span class="subst">&#123;answer&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(sep_line)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">log_error</span>(<span class="params">log_file, message, error=<span class="literal">None</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;统一记录错误日志&quot;&quot;&quot;</span></span><br><span class="line">    timestamp = datetime.datetime.now().strftime(<span class="string">&quot;%Y-%m-%d %H:%M:%S&quot;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;a&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        log_entry = <span class="string">f&quot;[<span class="subst">&#123;timestamp&#125;</span>] <span class="subst">&#123;message&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> error:</span><br><span class="line">            log_entry += <span class="string">f&quot;\n错误详情: <span class="subst">&#123;<span class="built_in">str</span>(error)&#125;</span>&quot;</span></span><br><span class="line">        log_entry += <span class="string">&quot;\n&quot;</span> + <span class="string">&quot;-&quot;</span>*<span class="number">50</span> + <span class="string">&quot;\n&quot;</span></span><br><span class="line">        f.write(log_entry)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>(<span class="params">file_path, log_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理单个文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">if</span> os.path.getsize(file_path) == <span class="number">0</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;跳过空文件: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r+&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            original_lines = f.readlines()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">any</span>(line.strip() <span class="keyword">for</span> line <span class="keyword">in</span> original_lines):</span><br><span class="line">                <span class="built_in">print</span>(<span class="string">f&quot;跳过内容为空的文件: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">            f.seek(<span class="number">0</span>)</span><br><span class="line">            f.truncate()</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> line_num, line <span class="keyword">in</span> <span class="built_in">enumerate</span>(original_lines, <span class="number">1</span>):</span><br><span class="line">                <span class="keyword">try</span>:</span><br><span class="line">                    <span class="keyword">if</span> <span class="keyword">not</span> line.strip():</span><br><span class="line">                        f.write(line)</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">                    original_text = line.strip()</span><br><span class="line">                    </span><br><span class="line">                    completion = client.chat.completions.create(</span><br><span class="line">                        model=<span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">                        messages=[&#123;</span><br><span class="line">                            <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">                            <span class="string">&#x27;content&#x27;</span>: <span class="string">f&#x27;&#x27;&#x27;原本句子中存在错词，不常见词语。可以修改词语和文字不采用偏僻词，不涵盖英语词汇，请严格按正常语序重组句子，只返回修改后的句子，不要任何解释。需要修改的句子：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;original_text&#125;</span>&#x27;&#x27;&#x27;</span></span><br><span class="line">                        &#125;]</span><br><span class="line">                    )</span><br><span class="line">                    </span><br><span class="line">                    modified = completion.choices[<span class="number">0</span>].message.content</span><br><span class="line">                    f.write(modified + line[<span class="built_in">len</span>(line.rstrip(<span class="string">&#x27;\n\r&#x27;</span>)):])</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 显示对话并保存</span></span><br><span class="line">                    print_dialog(original_text, modified)</span><br><span class="line">                    save_to_excel(original_text, modified, file_path)</span><br><span class="line">                    </span><br><span class="line">                <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">                    error_msg = <span class="string">f&quot;文件: <span class="subst">&#123;file_path&#125;</span> 第<span class="subst">&#123;line_num&#125;</span>行处理失败 - 保留原内容&quot;</span></span><br><span class="line">                    <span class="built_in">print</span>(<span class="string">f&quot;\n! 处理异常: <span class="subst">&#123;error_msg&#125;</span>&quot;</span>)</span><br><span class="line">                    log_error(log_file, error_msg, e)</span><br><span class="line">                    f.write(line)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">        error_msg = <span class="string">f&quot;文件处理失败: <span class="subst">&#123;file_path&#125;</span>&quot;</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n! 严重错误: <span class="subst">&#123;error_msg&#125;</span>&quot;</span>)</span><br><span class="line">        log_error(log_file, error_msg, e)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_folder</span>(<span class="params">folder_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理整个文件夹&quot;&quot;&quot;</span></span><br><span class="line">    log_file = os.path.join(folder_path, <span class="string">&quot;processing_errors.log&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(log_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        f.write(<span class="string">&quot;文本处理异常日志\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">f&quot;开始时间: <span class="subst">&#123;datetime.datetime.now().strftime(<span class="string">&#x27;%Y-%m-%d %H:%M:%S&#x27;</span>)&#125;</span>\n&quot;</span>)</span><br><span class="line">        f.write(<span class="string">&quot;=&quot;</span>*<span class="number">60</span> + <span class="string">&quot;\n&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    txt_files = glob.glob(os.path.join(folder_path, <span class="string">&#x27;**&#x27;</span>, <span class="string">&#x27;*.txt&#x27;</span>), recursive=<span class="literal">True</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> txt_files:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;在 <span class="subst">&#123;folder_path&#125;</span> 中未找到txt文件&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;开始批量处理，共发现 <span class="subst">&#123;<span class="built_in">len</span>(txt_files)&#125;</span> 个文本文件&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;处理记录将保存至: <span class="subst">&#123;os.path.abspath(excel_file)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> i, file_path <span class="keyword">in</span> <span class="built_in">enumerate</span>(txt_files, <span class="number">1</span>):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;\n正在处理文件 (<span class="subst">&#123;i&#125;</span>\&#123;len(txt_files)&#125;)：<span class="subst">&#123;os.path.basename(file_path)&#125;</span>&quot;</span>)</span><br><span class="line">        process_file(file_path, log_file)</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">60</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;处理完成！错误日志已保存至: <span class="subst">&#123;log_file&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;共处理 <span class="subst">&#123;<span class="built_in">len</span>(txt_files)*<span class="number">2</span>&#125;</span> 条记录到Excel文件&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        process_folder(<span class="string">&#x27;D:\\BaiduNetdiskDownload\\001-050_images&#x27;</span>)</span><br><span class="line">    <span class="keyword">finally</span>:</span><br><span class="line">        wb.close()</span><br></pre></td></tr></table></figure>


<h3 id="代码解析-3"><a href="#代码解析-3" class="headerlink" title="代码解析"></a>代码解析</h3><p>该代码的主要功能是批量处理指定文件夹中的文本文件，使用OpenAI的API对文本内容进行处理，然后将处理的记录保存到Excel文件中，并记录错误日志。以下是代码的详细分析：</p>
<h4 id="导入库-3"><a href="#导入库-3" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line"><span class="keyword">from</span> openai <span class="keyword">import</span> OpenAI</span><br><span class="line"><span class="keyword">import</span> openpyxl</span><br></pre></td></tr></table></figure>
<ul>
<li><code>os</code>: 用于文件和目录操作。</li>
<li><code>glob</code>: 用于查找符合特定规则的文件路径名。</li>
<li><code>datetime</code>: 用于处理日期和时间。</li>
<li><code>OpenAI</code>: 用于与OpenAI API交互。</li>
<li><code>openpyxl</code>: 用于处理Excel文件。</li>
</ul>
<h4 id="初始化OpenAI客户端"><a href="#初始化OpenAI客户端" class="headerlink" title="初始化OpenAI客户端"></a>初始化OpenAI客户端</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client = OpenAI(</span><br><span class="line">    api_key=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;https:\\dashscope.aliyuncs.com\compatible-mode\v1&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>初始化OpenAI API客户端，需提供API密钥。</li>
</ul>
<h4 id="初始化Excel文件"><a href="#初始化Excel文件" class="headerlink" title="初始化Excel文件"></a>初始化Excel文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">excel_file = <span class="string">&quot;D:\\text_processing_log.xlsx&quot;</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(excel_file):</span><br><span class="line">    wb = openpyxl.load_workbook(excel_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    wb = openpyxl.Workbook()</span><br><span class="line">ws = wb.active</span><br><span class="line">ws.title = <span class="string">&quot;处理记录&quot;</span></span><br><span class="line"><span class="keyword">if</span> ws.max_row == <span class="number">1</span>:</span><br><span class="line">    ws.append([<span class="string">&quot;类型&quot;</span>, <span class="string">&quot;内容&quot;</span>, <span class="string">&quot;文件路径&quot;</span>, <span class="string">&quot;处理时间&quot;</span>])</span><br></pre></td></tr></table></figure>
<ul>
<li>检查Excel文件是否存在，若不存在则创建新的Excel工作簿，并设置工作表标题和表头。</li>
</ul>
<h4 id="保存数据到Excel"><a href="#保存数据到Excel" class="headerlink" title="保存数据到Excel"></a>保存数据到Excel</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">save_to_excel</span>(<span class="params">question, answer, file_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数接受问题、答案和文件路径，并将它们写入Excel文件中，同时记录当前时间。</li>
</ul>
<h4 id="打印对话"><a href="#打印对话" class="headerlink" title="打印对话"></a>打印对话</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">print_dialog</span>(<span class="params">question, answer, max_width=<span class="number">80</span></span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>在命令行窗口美观地打印问题和答案，使用分隔线以增强可读性。</li>
</ul>
<h4 id="记录错误日志"><a href="#记录错误日志" class="headerlink" title="记录错误日志"></a>记录错误日志</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">log_error</span>(<span class="params">log_file, message, error=<span class="literal">None</span></span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>记录错误信息到日志文件中，格式化输出时间和错误详情。</li>
</ul>
<h4 id="处理单个文件"><a href="#处理单个文件" class="headerlink" title="处理单个文件"></a>处理单个文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>(<span class="params">file_path, log_file</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数负责读取文本文件，处理每一行文本，并调用OpenAI的API进行文本修改。</li>
</ul>
<h5 id="检查文件内容"><a href="#检查文件内容" class="headerlink" title="检查文件内容"></a>检查文件内容</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> os.path.getsize(file_path) == <span class="number">0</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;跳过空文件: <span class="subst">&#123;file_path&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br></pre></td></tr></table></figure>
<ul>
<li>跳过空文件和内容为空的文件。</li>
</ul>
<h5 id="读取和处理文本"><a href="#读取和处理文本" class="headerlink" title="读取和处理文本"></a>读取和处理文本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&#x27;r+&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    original_lines = f.readlines()</span><br></pre></td></tr></table></figure>
<ul>
<li>读取文件所有行，并逐行处理。</li>
</ul>
<h5 id="调用OpenAI-API"><a href="#调用OpenAI-API" class="headerlink" title="调用OpenAI API"></a>调用OpenAI API</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">completion = client.chat.completions.create(</span><br><span class="line">    model=<span class="string">&quot;qwen-plus&quot;</span>,</span><br><span class="line">    messages=[&#123;</span><br><span class="line">        <span class="string">&#x27;role&#x27;</span>: <span class="string">&#x27;user&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;content&#x27;</span>: <span class="string">f&#x27;&#x27;&#x27;原本句子中存在错词，不常见词语。可以修改词语和文字不采用偏僻词，不涵盖英语词汇，请严格按正常语序重组句子，只返回修改后的句子，不要任何解释。需要修改的句子：</span></span><br><span class="line"><span class="string"><span class="subst">&#123;original_text&#125;</span>&#x27;&#x27;&#x27;</span></span><br><span class="line">    &#125;]</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用OpenAI的API进行文本修改，API模型为<code>qwen-plus</code>。</li>
</ul>
<h5 id="保存修改后的文本"><a href="#保存修改后的文本" class="headerlink" title="保存修改后的文本"></a>保存修改后的文本</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">f.write(modified + line[<span class="built_in">len</span>(line.rstrip(<span class="string">&#x27;\n\r&#x27;</span>)):])</span><br></pre></td></tr></table></figure>
<ul>
<li>将修改后的文本写回文件，同时保留行末的换行符。</li>
</ul>
<h4 id="处理整个文件夹"><a href="#处理整个文件夹" class="headerlink" title="处理整个文件夹"></a>处理整个文件夹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_folder</span>(<span class="params">folder_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>遍历指定文件夹中的所有文本文件，并调用<code>process_file</code>进行处理。</li>
</ul>
<h5 id="日志记录"><a href="#日志记录" class="headerlink" title="日志记录"></a>日志记录</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">log_file = os.path.join(folder_path, <span class="string">&quot;processing_errors.log&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个日志文件来记录处理过程中出现的错误信息。</li>
</ul>
<h5 id="查找文本文件"><a href="#查找文本文件" class="headerlink" title="查找文本文件"></a>查找文本文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">txt_files = glob.glob(os.path.join(folder_path, <span class="string">&#x27;**&#x27;</span>, <span class="string">&#x27;*.txt&#x27;</span>), recursive=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>glob</code>模块查找指定文件夹下的所有文本文件。</li>
</ul>
<h4 id="主程序"><a href="#主程序" class="headerlink" title="主程序"></a>主程序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>该部分保证代码在作为主程序运行时执行文件夹处理函数。</li>
</ul>
<h3 id="Markdown-文件内容-3"><a href="#Markdown-文件内容-3" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 文本处理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本用于批量处理指定文件夹中的文本文件，使用OpenAI的API对文本内容进行处理，并将处理记录保存到Excel文件中，同时记录错误日志。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">import os</span></span><br><span class="line"><span class="code">import glob</span></span><br><span class="line"><span class="code">import datetime</span></span><br><span class="line"><span class="code">from openai import OpenAI</span></span><br><span class="line"><span class="code">import openpyxl</span></span><br></pre></td></tr></table></figure>

<h3 id="初始化OpenAI客户端-1"><a href="#初始化OpenAI客户端-1" class="headerlink" title="初始化OpenAI客户端"></a>初始化OpenAI客户端</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">client = OpenAI(</span><br><span class="line">    api_key=<span class="string">&quot;&quot;</span>,</span><br><span class="line">    base_url=<span class="string">&quot;https:\\dashscope.aliyuncs.com\compatible-mode\v1&quot;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<h3 id="初始化Excel文件-1"><a href="#初始化Excel文件-1" class="headerlink" title="初始化Excel文件"></a>初始化Excel文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">excel_file = <span class="string">&quot;D:\\text_processing_log.xlsx&quot;</span></span><br><span class="line"><span class="keyword">if</span> os.path.exists(excel_file):</span><br><span class="line">    wb = openpyxl.load_workbook(excel_file)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    wb = openpyxl.Workbook()</span><br><span class="line">ws = wb.active</span><br><span class="line">ws.title = <span class="string">&quot;处理记录&quot;</span></span><br><span class="line"><span class="keyword">if</span> ws.max_row == <span class="number">1</span>:</span><br><span class="line">    ws.append([<span class="string">&quot;类型&quot;</span>, <span class="string">&quot;内容&quot;</span>, <span class="string">&quot;文件路径&quot;</span>, <span class="string">&quot;处理时间&quot;</span>])</span><br></pre></td></tr></table></figure>

<h3 id="保存数据到Excel-1"><a href="#保存数据到Excel-1" class="headerlink" title="保存数据到Excel"></a>保存数据到Excel</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">save_to_excel</span>(<span class="params">question, answer, file_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>保存处理记录到Excel文件。</li>
</ul>
<h3 id="打印对话-1"><a href="#打印对话-1" class="headerlink" title="打印对话"></a>打印对话</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">print_dialog</span>(<span class="params">question, answer, max_width=<span class="number">80</span></span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>在命令行窗口美观地打印问题和答案。</li>
</ul>
<h3 id="记录错误日志-1"><a href="#记录错误日志-1" class="headerlink" title="记录错误日志"></a>记录错误日志</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">log_error</span>(<span class="params">log_file, message, error=<span class="literal">None</span></span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>记录错误信息到日志文件中。</li>
</ul>
<h3 id="处理单个文件-1"><a href="#处理单个文件-1" class="headerlink" title="处理单个文件"></a>处理单个文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_file</span>(<span class="params">file_path, log_file</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>读取文本文件，处理每一行文本，并调用OpenAI的API进行文本修改。</li>
</ul>
<h3 id="处理整个文件夹-1"><a href="#处理整个文件夹-1" class="headerlink" title="处理整个文件夹"></a>处理整个文件夹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_folder</span>(<span class="params">folder_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>遍历指定文件夹中的所有文本文件，并调用<code>process_file</code>进行处理。</li>
</ul>
<h2 id="使用说明-3"><a href="#使用说明-3" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>确保安装了必要的库：<code>pip install openai openpyxl</code>。</li>
<li>填写OpenAI API密钥。</li>
<li>修改文件夹路径以处理文本文件。</li>
<li>运行脚本，处理记录将保存到Excel文件中，错误日志将保存在文件夹中。</li>
</ol>
<h2 id="注意事项-3"><a href="#注意事项-3" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保OpenAI API服务可用。</li>
<li>检查文件夹路径和文件权限。</li>
</ul>
<h1 id="运用FishVideo大模型将文本信息转变为对应的语音"><a href="#运用FishVideo大模型将文本信息转变为对应的语音" class="headerlink" title="运用FishVideo大模型将文本信息转变为对应的语音"></a>运用FishVideo大模型将文本信息转变为对应的语音</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> fish_audio_sdk <span class="keyword">import</span> Session, TTSRequest, ReferenceAudio</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置日志记录异常</span></span><br><span class="line">logging.basicConfig(</span><br><span class="line">    filename=<span class="string">&#x27;tts_errors.log&#x27;</span>,</span><br><span class="line">    level=logging.ERROR,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_directory</span>(<span class="params">target_dir: <span class="built_in">str</span></span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理指定目录下的文本文件</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    Args:</span></span><br><span class="line"><span class="string">        target_dir: 包含文本文件和生成音频文件的目录</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    session = Session(<span class="string">&quot;&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    processed = <span class="number">0</span></span><br><span class="line">    skipped = <span class="number">0</span></span><br><span class="line">    errors = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(target_dir):</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> filename.endswith(<span class="string">&quot;.txt&quot;</span>):</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">        file_path = os.path.join(target_dir, filename)</span><br><span class="line">        base_name = os.path.splitext(filename)[<span class="number">0</span>]</span><br><span class="line">        audio_path = os.path.join(target_dir, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.mp3&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="comment"># 读取文本内容</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                text = f.read().strip()</span><br><span class="line"></span><br><span class="line">            <span class="comment"># 跳过空文件</span></span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">                logging.info(<span class="string">f&quot;跳过空文件: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">                skipped += <span class="number">1</span></span><br><span class="line">                <span class="keyword">continue</span></span><br><span class="line"></span><br><span class="line">            <span class="comment"># 生成语音文件</span></span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(audio_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">for</span> chunk <span class="keyword">in</span> session.tts(TTSRequest(</span><br><span class="line">                    reference_id=<span class="string">&quot;7f92f8afb8ec43bf81429cc1c9199cb1&quot;</span>,</span><br><span class="line">                    text=text</span><br><span class="line">                )):</span><br><span class="line">                    f.write(chunk)</span><br><span class="line"></span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;生成成功: <span class="subst">&#123;filename&#125;</span> -&gt; <span class="subst">&#123;os.path.basename(audio_path)&#125;</span>&quot;</span>)</span><br><span class="line">            processed += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            logging.error(<span class="string">f&quot;文件 <span class="subst">&#123;filename&#125;</span> 处理失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;错误: <span class="subst">&#123;filename&#125;</span> 转换失败，详见日志&quot;</span>)</span><br><span class="line">            errors += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 输出统计报告</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;\n处理完成: 成功 <span class="subst">&#123;processed&#125;</span> 个 | 跳过 <span class="subst">&#123;skipped&#125;</span> 个 | 失败 <span class="subst">&#123;errors&#125;</span> 个&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="comment"># 使用示例：处理当前目录下的文件</span></span><br><span class="line">    process_directory(target_dir=<span class="string">&quot;D:\\BaiduNetdiskDownload\\001-050_images&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="代码解析-4"><a href="#代码解析-4" class="headerlink" title="代码解析"></a>代码解析</h3><p>该代码的主要功能是处理指定目录下的文本文件，利用<code>fish_audio_sdk</code>库将文本转换为语音，并生成相应的音频文件。以下是代码的详细分析：</p>
<h4 id="导入库-4"><a href="#导入库-4" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> logging</span><br><span class="line"><span class="keyword">from</span> fish_audio_sdk <span class="keyword">import</span> Session, TTSRequest, ReferenceAudio</span><br></pre></td></tr></table></figure>
<ul>
<li><code>os</code>: 用于文件和目录操作。</li>
<li><code>logging</code>: 用于记录日志，方便后续的错误追踪和调试。</li>
<li><code>fish_audio_sdk</code>: 语音合成SDK，主要用于将文本转换为语音。</li>
</ul>
<h4 id="配置日志"><a href="#配置日志" class="headerlink" title="配置日志"></a>配置日志</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig(</span><br><span class="line">    filename=<span class="string">&#x27;tts_errors.log&#x27;</span>,</span><br><span class="line">    level=logging.ERROR,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置日志记录，日志将被写入<code>tts_errors.log</code>文件，记录错误信息及时间戳。</li>
</ul>
<h4 id="处理目录函数"><a href="#处理目录函数" class="headerlink" title="处理目录函数"></a>处理目录函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_directory</span>(<span class="params">target_dir: <span class="built_in">str</span></span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数接受一个参数<code>target_dir</code>，表示包含文本文件和生成音频文件的目录。</li>
</ul>
<h5 id="初始化变量"><a href="#初始化变量" class="headerlink" title="初始化变量"></a>初始化变量</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session = Session(<span class="string">&quot;&quot;</span>)</span><br><span class="line">processed = <span class="number">0</span></span><br><span class="line">skipped = <span class="number">0</span></span><br><span class="line">errors = <span class="number">0</span></span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个<code>Session</code>对象以进行语音合成。</li>
<li>初始化计数器：<code>processed</code>用于记录成功处理的文件数量，<code>skipped</code>用于记录跳过的文件数量，<code>errors</code>用于记录处理失败的文件数量。</li>
</ul>
<h5 id="遍历文件"><a href="#遍历文件" class="headerlink" title="遍历文件"></a>遍历文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(target_dir):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filename.endswith(<span class="string">&quot;.txt&quot;</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<ul>
<li>遍历指定目录下的文件，筛选出扩展名为<code>.txt</code>的文件。</li>
</ul>
<h5 id="处理每个文件"><a href="#处理每个文件" class="headerlink" title="处理每个文件"></a>处理每个文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file_path = os.path.join(target_dir, filename)</span><br><span class="line">base_name = os.path.splitext(filename)[<span class="number">0</span>]</span><br><span class="line">audio_path = os.path.join(target_dir, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.mp3&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>拼接文件路径和音频文件的保存路径。</li>
</ul>
<h6 id="读取文本内容"><a href="#读取文本内容" class="headerlink" title="读取文本内容"></a>读取文本内容</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read().strip()</span><br></pre></td></tr></table></figure>
<ul>
<li>读取文本文件内容，并去除首尾空格。</li>
</ul>
<h6 id="跳过空文件"><a href="#跳过空文件" class="headerlink" title="跳过空文件"></a>跳过空文件</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">    logging.info(<span class="string">f&quot;跳过空文件: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">    skipped += <span class="number">1</span></span><br><span class="line">    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<ul>
<li>如果文件内容为空，则记录日志并跳过处理。</li>
</ul>
<h6 id="生成语音文件"><a href="#生成语音文件" class="headerlink" title="生成语音文件"></a>生成语音文件</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(audio_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> session.tts(TTSRequest(</span><br><span class="line">        reference_id=<span class="string">&quot;7f92f8afb8ec43bf81429cc1c9199cb1&quot;</span>,</span><br><span class="line">        text=text</span><br><span class="line">    )):</span><br><span class="line">        f.write(chunk)</span><br></pre></td></tr></table></figure>
<ul>
<li>调用<code>session.tts</code>生成语音文件并写入到指定的路径。<code>TTSRequest</code>中包含了文本和一个参考ID。</li>
</ul>
<h6 id="成功处理"><a href="#成功处理" class="headerlink" title="成功处理"></a>成功处理</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;生成成功: <span class="subst">&#123;filename&#125;</span> -&gt; <span class="subst">&#123;os.path.basename(audio_path)&#125;</span>&quot;</span>)</span><br><span class="line">processed += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>打印生成成功的消息，并增加成功处理计数。</li>
</ul>
<h6 id="错误处理"><a href="#错误处理" class="headerlink" title="错误处理"></a>错误处理</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">    logging.error(<span class="string">f&quot;文件 <span class="subst">&#123;filename&#125;</span> 处理失败: <span class="subst">&#123;<span class="built_in">str</span>(e)&#125;</span>&quot;</span>, exc_info=<span class="literal">True</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;错误: <span class="subst">&#123;filename&#125;</span> 转换失败，详见日志&quot;</span>)</span><br><span class="line">    errors += <span class="number">1</span></span><br></pre></td></tr></table></figure>
<ul>
<li>捕获异常，记录错误并增加失败计数。</li>
</ul>
<h5 id="输出统计报告"><a href="#输出统计报告" class="headerlink" title="输出统计报告"></a>输出统计报告</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n处理完成: 成功 <span class="subst">&#123;processed&#125;</span> 个 | 跳过 <span class="subst">&#123;skipped&#125;</span> 个 | 失败 <span class="subst">&#123;errors&#125;</span> 个&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>在处理完成后输出统计报告。</li>
</ul>
<h4 id="主程序-1"><a href="#主程序-1" class="headerlink" title="主程序"></a>主程序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    process_directory(target_dir=<span class="string">&quot;D:\\BaiduNetdiskDownload\\001-050_images&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>主程序入口，调用<code>process_directory</code>处理指定目录下的文本文件。</li>
</ul>
<h3 id="Markdown-文件内容-4"><a href="#Markdown-文件内容-4" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 文本转语音处理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本用于处理指定目录下的文本文件，通过<span class="code">`fish_audio_sdk`</span>将文本转换为语音，并生成对应的音频文件。处理过程中会记录成功、跳过和失败的文件数量，并将错误日志保存到文件中。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">import os</span></span><br><span class="line"><span class="code">import logging</span></span><br><span class="line"><span class="code">from fish_audio_sdk import Session, TTSRequest, ReferenceAudio</span></span><br></pre></td></tr></table></figure>

<h3 id="配置日志-1"><a href="#配置日志-1" class="headerlink" title="配置日志"></a>配置日志</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">logging.basicConfig(</span><br><span class="line">    filename=<span class="string">&#x27;tts_errors.log&#x27;</span>,</span><br><span class="line">    level=logging.ERROR,</span><br><span class="line">    <span class="built_in">format</span>=<span class="string">&#x27;%(asctime)s - %(levelname)s - %(message)s&#x27;</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<ul>
<li>配置日志记录，记录错误信息到<code>tts_errors.log</code>文件中。</li>
</ul>
<h3 id="处理目录函数-1"><a href="#处理目录函数-1" class="headerlink" title="处理目录函数"></a>处理目录函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_directory</span>(<span class="params">target_dir: <span class="built_in">str</span></span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>处理指定目录下的文本文件，并生成语音文件。</li>
</ul>
<h4 id="初始化变量-1"><a href="#初始化变量-1" class="headerlink" title="初始化变量"></a>初始化变量</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">session = Session(<span class="string">&quot;&quot;</span>)</span><br><span class="line">processed = <span class="number">0</span></span><br><span class="line">skipped = <span class="number">0</span></span><br><span class="line">errors = <span class="number">0</span></span><br></pre></td></tr></table></figure>

<h4 id="遍历文件-1"><a href="#遍历文件-1" class="headerlink" title="遍历文件"></a>遍历文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> filename <span class="keyword">in</span> os.listdir(target_dir):</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> filename.endswith(<span class="string">&quot;.txt&quot;</span>):</span><br><span class="line">        <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>
<ul>
<li>只处理扩展名为<code>.txt</code>的文件。</li>
</ul>
<h4 id="处理每个文件-1"><a href="#处理每个文件-1" class="headerlink" title="处理每个文件"></a>处理每个文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">file_path = os.path.join(target_dir, filename)</span><br><span class="line">base_name = os.path.splitext(filename)[<span class="number">0</span>]</span><br><span class="line">audio_path = os.path.join(target_dir, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.mp3&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>生成文本文件的路径和对应的音频文件路径。</li>
</ul>
<h4 id="读取文本内容-1"><a href="#读取文本内容-1" class="headerlink" title="读取文本内容"></a>读取文本内容</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(file_path, <span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    text = f.read().strip()</span><br></pre></td></tr></table></figure>

<h4 id="跳过空文件-1"><a href="#跳过空文件-1" class="headerlink" title="跳过空文件"></a>跳过空文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="keyword">not</span> text:</span><br><span class="line">    logging.info(<span class="string">f&quot;跳过空文件: <span class="subst">&#123;filename&#125;</span>&quot;</span>)</span><br><span class="line">    skipped += <span class="number">1</span></span><br><span class="line">    <span class="keyword">continue</span></span><br></pre></td></tr></table></figure>

<h4 id="生成语音文件-1"><a href="#生成语音文件-1" class="headerlink" title="生成语音文件"></a>生成语音文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(audio_path, <span class="string">&quot;wb&quot;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> chunk <span class="keyword">in</span> session.tts(TTSRequest(</span><br><span class="line">        reference_id=<span class="string">&quot;7f92f8afb8ec43bf81429cc1c9199cb1&quot;</span>,</span><br><span class="line">        text=text</span><br><span class="line">    )):</span><br><span class="line">        f.write(chunk)</span><br></pre></td></tr></table></figure>

<h4 id="输出统计报告-1"><a href="#输出统计报告-1" class="headerlink" title="输出统计报告"></a>输出统计报告</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;\n处理完成: 成功 <span class="subst">&#123;processed&#125;</span> 个 | 跳过 <span class="subst">&#123;skipped&#125;</span> 个 | 失败 <span class="subst">&#123;errors&#125;</span> 个&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="使用说明-4"><a href="#使用说明-4" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>确保已安装<code>fish_audio_sdk</code>库。</li>
<li>将要处理的文本文件放入指定目录。</li>
<li>运行脚本，生成的音频文件将与文本文件保存在同一目录中。</li>
</ol>
<h2 id="注意事项-4"><a href="#注意事项-4" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保<code>fish_audio_sdk</code>的配置正确，API密钥和参考ID有效。</li>
<li>检查文件权限，确保可以读取文本文件和写入音频文件。</li>
</ul>
<h1 id="图片转视频处理将图片与语音结合并添加转场"><a href="#图片转视频处理将图片与语音结合并添加转场" class="headerlink" title="图片转视频处理将图片与语音结合并添加转场"></a>图片转视频处理将图片与语音结合并添加转场</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="comment"># 支持的图片和音频扩展名</span></span><br><span class="line">IMAGE_EXTENSIONS = [<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>]</span><br><span class="line">AUDIO_EXTENSIONS = [<span class="string">&#x27;.mp3&#x27;</span>, <span class="string">&#x27;.wav&#x27;</span>, <span class="string">&#x27;.ogg&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_audio_file</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找与图片同名的音频文件&quot;&quot;&quot;</span></span><br><span class="line">    base_name = os.path.splitext(image_path)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> AUDIO_EXTENSIONS:</span><br><span class="line">        audio_path = <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(audio_path):</span><br><span class="line">            <span class="keyword">return</span> audio_path</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_video</span>(<span class="params">image_path, output_folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用 FFmpeg 创建视频&quot;&quot;&quot;</span></span><br><span class="line">    base_name = os.path.splitext(os.path.basename(image_path))[<span class="number">0</span>]</span><br><span class="line">    output_path = os.path.join(output_folder, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.mp4&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    cmd = [</span><br><span class="line">        <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-y&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-loop&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, image_path,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> audio_path := find_audio_file(image_path):</span><br><span class="line">        cmd += [<span class="string">&#x27;-i&#x27;</span>, audio_path]</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        cmd += [</span><br><span class="line">            <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;lavfi&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;anullsrc=cl=stereo:r=44100&#x27;</span>,</span><br><span class="line">            <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;3&#x27;</span></span><br><span class="line">        ]</span><br><span class="line"></span><br><span class="line">    cmd += [</span><br><span class="line">        <span class="string">&#x27;-vf&#x27;</span>, </span><br><span class="line">        <span class="string">&#x27;scale=trunc(iw\2)*2:trunc(ih\2)*2,fps=24,format=yuv420p&#x27;</span>,  <span class="comment"># 关键修改点</span></span><br><span class="line">        <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;libx264&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;aac&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-shortest&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-movflags&#x27;</span>, <span class="string">&#x27;+faststart&#x27;</span>,</span><br><span class="line">        output_path</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        subprocess.run(cmd, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;FFmpeg 错误: <span class="subst">&#123;e.stderr&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_folder</span>(<span class="params">folder_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理整个文件夹&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 收集所有图片文件</span></span><br><span class="line">    image_files = []</span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> IMAGE_EXTENSIONS:</span><br><span class="line">        image_files.extend(glob.glob(os.path.join(folder_path, <span class="string">&#x27;*&#x27;</span> + ext)))</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 创建输出目录</span></span><br><span class="line">    output_folder = os.path.join(folder_path, <span class="string">&quot;output_videos&quot;</span>)</span><br><span class="line">    os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 处理每个图片文件</span></span><br><span class="line">    <span class="keyword">for</span> img_file <span class="keyword">in</span> image_files:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;正在处理: <span class="subst">&#123;os.path.basename(img_file)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> create_video(img_file, output_folder):</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;成功创建: <span class="subst">&#123;os.path.basename(img_file)&#125;</span>.mp4&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;处理失败: <span class="subst">&#123;os.path.basename(img_file)&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    target_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\001-050_images&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_folder):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 目录不存在 - <span class="subst">&#123;target_folder&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        process_folder(target_folder)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;全部处理完成！&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="代码解析-5"><a href="#代码解析-5" class="headerlink" title="代码解析"></a>代码解析</h3><p>该代码的主要功能是使用FFmpeg将指定文件夹中的图片转换为视频，并在视频中添加与图片同名的音频文件（如果存在）。以下是代码的详细分析：</p>
<h4 id="导入库-5"><a href="#导入库-5" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br></pre></td></tr></table></figure>
<ul>
<li><code>os</code>: 用于文件和目录操作。</li>
<li><code>glob</code>: 用于查找符合特定规则的文件路径名。</li>
<li><code>subprocess</code>: 用于执行外部命令，这里用来调用FFmpeg。</li>
</ul>
<h4 id="支持的文件扩展名"><a href="#支持的文件扩展名" class="headerlink" title="支持的文件扩展名"></a>支持的文件扩展名</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_EXTENSIONS = [<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>]</span><br><span class="line">AUDIO_EXTENSIONS = [<span class="string">&#x27;.mp3&#x27;</span>, <span class="string">&#x27;.wav&#x27;</span>, <span class="string">&#x27;.ogg&#x27;</span>]</span><br></pre></td></tr></table></figure>
<ul>
<li>定义支持的图像和音频文件扩展名。</li>
</ul>
<h4 id="查找音频文件"><a href="#查找音频文件" class="headerlink" title="查找音频文件"></a>查找音频文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_audio_file</span>(<span class="params">image_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;查找与图片同名的音频文件&quot;&quot;&quot;</span></span><br><span class="line">    base_name = os.path.splitext(image_path)[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">for</span> ext <span class="keyword">in</span> AUDIO_EXTENSIONS:</span><br><span class="line">        audio_path = <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span><span class="subst">&#123;ext&#125;</span>&quot;</span></span><br><span class="line">        <span class="keyword">if</span> os.path.exists(audio_path):</span><br><span class="line">            <span class="keyword">return</span> audio_path</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<ul>
<li>该函数接收图片路径，查找是否存在与之同名的音频文件，并返回找到的音频文件路径，如果未找到则返回<code>None</code>。</li>
</ul>
<h4 id="创建视频"><a href="#创建视频" class="headerlink" title="创建视频"></a>创建视频</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_video</span>(<span class="params">image_path, output_folder</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用 FFmpeg 创建视频&quot;&quot;&quot;</span></span><br><span class="line">    base_name = os.path.splitext(os.path.basename(image_path))[<span class="number">0</span>]</span><br><span class="line">    output_path = os.path.join(output_folder, <span class="string">f&quot;<span class="subst">&#123;base_name&#125;</span>.mp4&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>函数负责使用FFmpeg将图片转换为视频。</li>
</ul>
<h5 id="构建FFmpeg命令"><a href="#构建FFmpeg命令" class="headerlink" title="构建FFmpeg命令"></a>构建FFmpeg命令</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cmd = [</span><br><span class="line">    <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-loop&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, image_path,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>-loop 1</code>选项使图片循环显示。</li>
</ul>
<h6 id="添加音频"><a href="#添加音频" class="headerlink" title="添加音频"></a>添加音频</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> audio_path := find_audio_file(image_path):</span><br><span class="line">    cmd += [<span class="string">&#x27;-i&#x27;</span>, audio_path]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cmd += [</span><br><span class="line">        <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;lavfi&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;anullsrc=cl=stereo:r=44100&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;3&#x27;</span></span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>
<ul>
<li>如果找到与图片同名的音频文件，则将其添加到FFmpeg命令中；否则，使用虚拟音频源（无声）生成长度为3秒的音频。</li>
</ul>
<h6 id="设定视频输出参数"><a href="#设定视频输出参数" class="headerlink" title="设定视频输出参数"></a>设定视频输出参数</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmd += [</span><br><span class="line">    <span class="string">&#x27;-vf&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;scale=trunc(iw\2)*2:trunc(ih\2)*2,fps=24,format=yuv420p&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;libx264&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;aac&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-shortest&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-movflags&#x27;</span>, <span class="string">&#x27;+faststart&#x27;</span>,</span><br><span class="line">    output_path</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<ul>
<li>设置视频过滤器，确保宽高是偶数，并设置每秒帧数（fps）为24。视频编码器为<code>libx264</code>，音频编码器为<code>aac</code>。</li>
</ul>
<h6 id="运行FFmpeg命令"><a href="#运行FFmpeg命令" class="headerlink" title="运行FFmpeg命令"></a>运行FFmpeg命令</h6><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>:</span><br><span class="line">    subprocess.run(cmd, check=<span class="literal">True</span>, capture_output=<span class="literal">True</span>, text=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line"><span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;FFmpeg 错误: <span class="subst">&#123;e.stderr&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">False</span></span><br></pre></td></tr></table></figure>
<ul>
<li>执行命令并处理可能出现的错误。</li>
</ul>
<h4 id="处理文件夹"><a href="#处理文件夹" class="headerlink" title="处理文件夹"></a>处理文件夹</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_folder</span>(<span class="params">folder_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理整个文件夹&quot;&quot;&quot;</span></span><br></pre></td></tr></table></figure>
<ul>
<li>该函数遍历指定目录，处理所有支持的图片文件。</li>
</ul>
<h5 id="收集图片文件"><a href="#收集图片文件" class="headerlink" title="收集图片文件"></a>收集图片文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">image_files = []</span><br><span class="line"><span class="keyword">for</span> ext <span class="keyword">in</span> IMAGE_EXTENSIONS:</span><br><span class="line">    image_files.extend(glob.glob(os.path.join(folder_path, <span class="string">&#x27;*&#x27;</span> + ext)))</span><br></pre></td></tr></table></figure>
<ul>
<li>使用<code>glob</code>查找所有支持的图片文件。</li>
</ul>
<h5 id="创建输出目录-2"><a href="#创建输出目录-2" class="headerlink" title="创建输出目录"></a>创建输出目录</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">output_folder = os.path.join(folder_path, <span class="string">&quot;output_videos&quot;</span>)</span><br><span class="line">os.makedirs(output_folder, exist_ok=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个名为<code>output_videos</code>的文件夹，用于保存生成的视频文件。</li>
</ul>
<h5 id="处理每个图片文件"><a href="#处理每个图片文件" class="headerlink" title="处理每个图片文件"></a>处理每个图片文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> img_file <span class="keyword">in</span> image_files:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;正在处理: <span class="subst">&#123;os.path.basename(img_file)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> create_video(img_file, output_folder):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功创建: <span class="subst">&#123;os.path.basename(img_file)&#125;</span>.mp4&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;处理失败: <span class="subst">&#123;os.path.basename(img_file)&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span> * <span class="number">50</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>对每个图片文件调用<code>create_video</code>函数，并报告处理结果。</li>
</ul>
<h4 id="主程序-2"><a href="#主程序-2" class="headerlink" title="主程序"></a>主程序</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    target_folder = <span class="string">&quot;D:\\BaiduNetdiskDownload\\001-050_images&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(target_folder):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误: 目录不存在 - <span class="subst">&#123;target_folder&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        process_folder(target_folder)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;全部处理完成！&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>主程序入口，检查目标文件夹是否存在，并调用<code>process_folder</code>处理图像。</li>
</ul>
<h3 id="Markdown-文件内容-5"><a href="#Markdown-文件内容-5" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 图片转视频处理脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本用于将指定文件夹中的图片文件转换为视频，并在视频中添加与图片同名的音频文件（如果存在）。生成的视频文件将保存到一个单独的输出目录中。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">import os</span></span><br><span class="line"><span class="code">import glob</span></span><br><span class="line"><span class="code">import subprocess</span></span><br></pre></td></tr></table></figure>

<h3 id="支持的文件扩展名-1"><a href="#支持的文件扩展名-1" class="headerlink" title="支持的文件扩展名"></a>支持的文件扩展名</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">IMAGE_EXTENSIONS = [<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>]</span><br><span class="line">AUDIO_EXTENSIONS = [<span class="string">&#x27;.mp3&#x27;</span>, <span class="string">&#x27;.wav&#x27;</span>, <span class="string">&#x27;.ogg&#x27;</span>]</span><br></pre></td></tr></table></figure>

<h3 id="查找音频文件-1"><a href="#查找音频文件-1" class="headerlink" title="查找音频文件"></a>查找音频文件</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">find_audio_file</span>(<span class="params">image_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>查找与图片同名的音频文件。</li>
</ul>
<h3 id="创建视频-1"><a href="#创建视频-1" class="headerlink" title="创建视频"></a>创建视频</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">create_video</span>(<span class="params">image_path, output_folder</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>使用FFmpeg将图片转换为视频。</li>
</ul>
<h4 id="构建FFmpeg命令-1"><a href="#构建FFmpeg命令-1" class="headerlink" title="构建FFmpeg命令"></a>构建FFmpeg命令</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cmd = [</span><br><span class="line">    <span class="string">&#x27;ffmpeg&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-y&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-loop&#x27;</span>, <span class="string">&#x27;1&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-i&#x27;</span>, image_path,</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h4 id="添加音频-1"><a href="#添加音频-1" class="headerlink" title="添加音频"></a>添加音频</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> audio_path := find_audio_file(image_path):</span><br><span class="line">    cmd += [<span class="string">&#x27;-i&#x27;</span>, audio_path]</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    cmd += [</span><br><span class="line">        <span class="string">&#x27;-f&#x27;</span>, <span class="string">&#x27;lavfi&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-i&#x27;</span>, <span class="string">&#x27;anullsrc=cl=stereo:r=44100&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;-t&#x27;</span>, <span class="string">&#x27;3&#x27;</span></span><br><span class="line">    ]</span><br></pre></td></tr></table></figure>

<h4 id="设置视频输出参数"><a href="#设置视频输出参数" class="headerlink" title="设置视频输出参数"></a>设置视频输出参数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cmd += [</span><br><span class="line">    <span class="string">&#x27;-vf&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;scale=trunc(iw\2)*2:trunc(ih\2)*2,fps=24,format=yuv420p&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c:v&#x27;</span>, <span class="string">&#x27;libx264&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-c:a&#x27;</span>, <span class="string">&#x27;aac&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-shortest&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;-movflags&#x27;</span>, <span class="string">&#x27;+faststart&#x27;</span>,</span><br><span class="line">    output_path</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<h3 id="处理文件夹-1"><a href="#处理文件夹-1" class="headerlink" title="处理文件夹"></a>处理文件夹</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_folder</span>(<span class="params">folder_path</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>处理指定目录中的所有图片文件，并生成视频。</li>
</ul>
<h3 id="主程序-3"><a href="#主程序-3" class="headerlink" title="主程序"></a>主程序</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br></pre></td></tr></table></figure>
<ul>
<li>检查目标目录并执行处理。</li>
</ul>
<h2 id="使用说明-5"><a href="#使用说明-5" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>确保已安装FFmpeg并将其路径添加到系统环境变量。</li>
<li>将要处理的图片文件放入指定目录。</li>
<li>运行脚本，生成的视频文件将保存到<code>output_videos</code>子目录中。</li>
</ol>
<h2 id="注意事项-5"><a href="#注意事项-5" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保文件夹路径和文件权限正确。</li>
<li>处理时请检查FFmpeg的输出信息以获取错误提示。</li>
</ul>
<h1 id="合并视频段"><a href="#合并视频段" class="headerlink" title="合并视频段"></a>合并视频段</h1><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">merge_videos</span>(<span class="params">folder_path, output_file</span>):</span><br><span class="line">    <span class="comment"># 获取所有视频文件</span></span><br><span class="line">    video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(folder_path) <span class="keyword">if</span> f.endswith((<span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>))]</span><br><span class="line">    video_files.sort()  <span class="comment"># 根据名称排序，确保顺序正确</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># 生成 FFmpeg 需要的输入列表文件</span></span><br><span class="line">    list_file = os.path.join(folder_path, <span class="string">&#x27;file_list.txt&#x27;</span>)</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(list_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">for</span> video <span class="keyword">in</span> video_files:</span><br><span class="line">            f.write(<span class="string">f&quot;file &#x27;<span class="subst">&#123;os.path.join(folder_path, video)&#125;</span>&#x27;\n&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># FFmpeg 合并视频</span></span><br><span class="line">    ffmpeg_cmd = <span class="string">f&#x27;ffmpeg -f concat -safe 0 -i &quot;<span class="subst">&#123;list_file&#125;</span>&quot; -c copy &quot;<span class="subst">&#123;output_file&#125;</span>&quot;&#x27;</span></span><br><span class="line">    subprocess.run(ffmpeg_cmd, shell=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 清理文件</span></span><br><span class="line">    os.remove(list_file)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;合并完成：<span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用示例</span></span><br><span class="line">merge_videos(<span class="string">&quot;D:\\BaiduNetdiskDownload\\001-050_images\\output_videos&quot;</span>, <span class="string">&quot;output.mp4&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>下面是对您提供的Python代码的详细解析，以及生成的Markdown文件内容。</p>
<h3 id="代码解析-6"><a href="#代码解析-6" class="headerlink" title="代码解析"></a>代码解析</h3><h4 id="导入库-6"><a href="#导入库-6" class="headerlink" title="导入库"></a>导入库</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br></pre></td></tr></table></figure>
<ul>
<li><code>os</code>: 用于文件和目录操作。</li>
<li><code>subprocess</code>: 用于执行外部命令，这里用来调用FFmpeg。</li>
</ul>
<h4 id="合并视频函数"><a href="#合并视频函数" class="headerlink" title="合并视频函数"></a>合并视频函数</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_videos</span>(<span class="params">folder_path, output_file</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数接受两个参数：一个是包含视频文件的文件夹路径，另一个是合并后输出视频文件的名称。</li>
</ul>
<h5 id="获取视频文件"><a href="#获取视频文件" class="headerlink" title="获取视频文件"></a>获取视频文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(folder_path) <span class="keyword">if</span> f.endswith((<span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>))]</span><br><span class="line">video_files.sort()  <span class="comment"># 根据名称排序，确保顺序正确</span></span><br></pre></td></tr></table></figure>
<ul>
<li>获取指定文件夹中的所有视频文件，筛选出扩展名为<code>.mp4</code>、<code>.mkv</code>、<code>.avi</code>和<code>.mov</code>的视频文件，并将其按名称排序，以确保合并顺序正确。</li>
</ul>
<h5 id="生成FFmpeg输入列表文件"><a href="#生成FFmpeg输入列表文件" class="headerlink" title="生成FFmpeg输入列表文件"></a>生成FFmpeg输入列表文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list_file = os.path.join(folder_path, <span class="string">&#x27;file_list.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(list_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> video <span class="keyword">in</span> video_files:</span><br><span class="line">        f.write(<span class="string">f&quot;file &#x27;<span class="subst">&#123;os.path.join(folder_path, video)&#125;</span>&#x27;\n&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>创建一个名为<code>file_list.txt</code>的文本文件，FFmpeg将使用这个文件来读取需要合并的视频文件路径。每行包含一个视频文件的路径。</li>
</ul>
<h5 id="执行FFmpeg命令"><a href="#执行FFmpeg命令" class="headerlink" title="执行FFmpeg命令"></a>执行FFmpeg命令</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg_cmd = <span class="string">f&#x27;ffmpeg -f concat -safe 0 -i &quot;<span class="subst">&#123;list_file&#125;</span>&quot; -c copy &quot;<span class="subst">&#123;output_file&#125;</span>&quot;&#x27;</span></span><br><span class="line">subprocess.run(ffmpeg_cmd, shell=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>构建FFmpeg命令，使用<code>-f concat</code>选项来合并文件，并使用<code>-c copy</code>选项以快速地复制视频流而不进行重新编码。通过<code>subprocess.run</code>执行命令。</li>
</ul>
<h5 id="清理临时文件"><a href="#清理临时文件" class="headerlink" title="清理临时文件"></a>清理临时文件</h5><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">os.remove(list_file)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;合并完成：<span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>合并完成后删除临时的<code>file_list.txt</code>文件，并打印合并完成的消息。</li>
</ul>
<h3 id="使用示例"><a href="#使用示例" class="headerlink" title="使用示例"></a>使用示例</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">merge_videos(<span class="string">&quot;D:\\BaiduNetdiskDownload\\001-050_images\\output_videos&quot;</span>, <span class="string">&quot;output.mp4&quot;</span>)</span><br></pre></td></tr></table></figure>
<ul>
<li>调用<code>merge_videos</code>函数，传入包含视频文件的文件夹路径和输出文件名。</li>
</ul>
<h3 id="Markdown-文件内容-6"><a href="#Markdown-文件内容-6" class="headerlink" title="Markdown 文件内容"></a>Markdown 文件内容</h3><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="section"># 视频合并脚本</span></span><br><span class="line"></span><br><span class="line"><span class="section">## 概述</span></span><br><span class="line">该脚本用于将指定文件夹中的多个视频文件合并为一个视频，使用FFmpeg工具来完成合并操作。</span><br><span class="line"></span><br><span class="line"><span class="section">## 代码解析</span></span><br><span class="line"></span><br><span class="line"><span class="section">### 导入库</span></span><br><span class="line"><span class="code">```python</span></span><br><span class="line"><span class="code">import os</span></span><br><span class="line"><span class="code">import subprocess</span></span><br></pre></td></tr></table></figure>
<ul>
<li><code>os</code>: 用于文件和目录操作。</li>
<li><code>subprocess</code>: 用于执行外部命令，这里用来调用FFmpeg。</li>
</ul>
<h3 id="合并视频函数-1"><a href="#合并视频函数-1" class="headerlink" title="合并视频函数"></a>合并视频函数</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">merge_videos</span>(<span class="params">folder_path, output_file</span>):</span><br></pre></td></tr></table></figure>
<ul>
<li>该函数接受两个参数：包含视频文件的文件夹路径和合并后输出视频文件的名称。</li>
</ul>
<h4 id="获取视频文件-1"><a href="#获取视频文件-1" class="headerlink" title="获取视频文件"></a>获取视频文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">video_files = [f <span class="keyword">for</span> f <span class="keyword">in</span> os.listdir(folder_path) <span class="keyword">if</span> f.endswith((<span class="string">&#x27;.mp4&#x27;</span>, <span class="string">&#x27;.mkv&#x27;</span>, <span class="string">&#x27;.avi&#x27;</span>, <span class="string">&#x27;.mov&#x27;</span>))]</span><br><span class="line">video_files.sort()  <span class="comment"># 根据名称排序，确保顺序正确</span></span><br></pre></td></tr></table></figure>

<h4 id="生成FFmpeg输入列表文件-1"><a href="#生成FFmpeg输入列表文件-1" class="headerlink" title="生成FFmpeg输入列表文件"></a>生成FFmpeg输入列表文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">list_file = os.path.join(folder_path, <span class="string">&#x27;file_list.txt&#x27;</span>)</span><br><span class="line"><span class="keyword">with</span> <span class="built_in">open</span>(list_file, <span class="string">&#x27;w&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">    <span class="keyword">for</span> video <span class="keyword">in</span> video_files:</span><br><span class="line">        f.write(<span class="string">f&quot;file &#x27;<span class="subst">&#123;os.path.join(folder_path, video)&#125;</span>&#x27;\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="执行FFmpeg命令-1"><a href="#执行FFmpeg命令-1" class="headerlink" title="执行FFmpeg命令"></a>执行FFmpeg命令</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ffmpeg_cmd = <span class="string">f&#x27;ffmpeg -f concat -safe 0 -i &quot;<span class="subst">&#123;list_file&#125;</span>&quot; -c copy &quot;<span class="subst">&#123;output_file&#125;</span>&quot;&#x27;</span></span><br><span class="line">subprocess.run(ffmpeg_cmd, shell=<span class="literal">True</span>, check=<span class="literal">True</span>)</span><br></pre></td></tr></table></figure>

<h4 id="清理临时文件-1"><a href="#清理临时文件-1" class="headerlink" title="清理临时文件"></a>清理临时文件</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">os.remove(list_file)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">f&quot;合并完成：<span class="subst">&#123;output_file&#125;</span>&quot;</span>)</span><br></pre></td></tr></table></figure>

<h2 id="使用说明-6"><a href="#使用说明-6" class="headerlink" title="使用说明"></a>使用说明</h2><ol>
<li>确保已安装FFmpeg并将其路径添加到系统环境变量。</li>
<li>将要合并的视频文件放入指定文件夹。</li>
<li>运行脚本，将多个视频合并为一个视频文件。</li>
</ol>
<h2 id="注意事项-6"><a href="#注意事项-6" class="headerlink" title="注意事项"></a>注意事项</h2><ul>
<li>确保所有视频文件格式相同，以避免合并时出现问题。</li>
<li>处理时请检查FFmpeg的输出信息以获取可能的错误提示。</li>
</ul>
<p>仓库代码<br><a target="_blank" rel="noopener" href="https://github.com/qingyun201908/AIDrowToVideo">AIDrow</a></p>
<p><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/AI%E5%A4%84%E7%90%86%E6%BC%AB%E7%94%BB%E8%BD%AC%E8%A7%86%E9%A2%91/image_20250409202305.png" alt="alt text"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/06/%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7/%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E5%B7%A5%E5%85%B7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qing Yun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/06/%E4%BB%A3%E7%A0%81%E5%B7%A5%E5%85%B7/%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E5%B7%A5%E5%85%B7/" class="post-title-link" itemprop="url">自动化图床工具使用文档</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-06 23:32:53" itemprop="dateCreated datePublished" datetime="2025-03-06T23:32:53+00:00">2025-03-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-06 00:32:32" itemprop="dateModified" datetime="2025-06-06T00:32:32+00:00">2025-06-06</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="自动化-Markdown-图片上传到-GitHub"><a href="#自动化-Markdown-图片上传到-GitHub" class="headerlink" title="自动化 Markdown 图片上传到 GitHub"></a>自动化 Markdown 图片上传到 GitHub</h1><h2 id="1-代码介绍"><a href="#1-代码介绍" class="headerlink" title="1. 代码介绍"></a>1. 代码介绍</h2><p>本代码用于自动扫描指定目录下的 Markdown 文章，提取其中的本地图片，并上传到 GitHub 仓库，最后替换文章中的图片路径，实现图片的托管和访问加速。</p>
<h2 id="2-主要功能"><a href="#2-主要功能" class="headerlink" title="2. 主要功能"></a>2. 主要功能</h2><ul>
<li>读取本地配置文件，加载 GitHub Token</li>
<li>扫描 Markdown 文章，查找本地图片</li>
<li>判断图片是否已处理，避免重复上传</li>
<li>将图片上传到 GitHub 指定仓库和分支</li>
<li>更新 Markdown 文章中的图片链接</li>
<li>记录处理过的文件哈希值，避免重复处理</li>
</ul>
<h2 id="3-代码解析"><a href="#3-代码解析" class="headerlink" title="3. 代码解析"></a>3. 代码解析</h2><h3 id="3-1-配置文件管理"><a href="#3-1-配置文件管理" class="headerlink" title="3.1 配置文件管理"></a>3.1 配置文件管理</h3><p>代码首先定义了 <code>CONFIG_FILE</code> 路径 (<code>~\.image_upload_config.json</code>)，用于存储 GitHub Token。然后 <code>load_github_token()</code> 函数用于读取该文件，并获取 <code>GITHUB_TOKEN</code>。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_FILE = Path.home() \ <span class="string">&quot;.image_upload_config.json&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">load_github_token</span>():</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(CONFIG_FILE, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            config = json.load(f)</span><br><span class="line">            token = config.get(<span class="string">&quot;GITHUB_TOKEN&quot;</span>)</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> token:</span><br><span class="line">                <span class="keyword">raise</span> ValueError(<span class="string">&quot;配置文件中缺少GITHUB_TOKEN字段&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> token</span><br><span class="line">    <span class="keyword">except</span> FileNotFoundError:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;错误：配置文件 <span class="subst">&#123;CONFIG_FILE&#125;</span> 不存在。请创建该文件并包含GITHUB_TOKEN字段。&quot;</span>)</span><br><span class="line">        exit(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>

<h3 id="3-2-全局配置项"><a href="#3-2-全局配置项" class="headerlink" title="3.2 全局配置项"></a>3.2 全局配置项</h3><p>定义了 <code>CONFIG</code> 字典，包含 GitHub 仓库信息、文章目录、允许的图片格式等。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">CONFIG = &#123;</span><br><span class="line">    <span class="string">&quot;GITHUB_TOKEN&quot;</span>: load_github_token(),</span><br><span class="line">    <span class="string">&quot;REPO&quot;</span>: <span class="string">&quot;qingyun201908\qingyun201908.github.io&quot;</span>,</span><br><span class="line">    <span class="string">&quot;BRANCH&quot;</span>: <span class="string">&quot;images&quot;</span>,</span><br><span class="line">    <span class="string">&quot;POSTS_DIR&quot;</span>: Path(<span class="string">r&quot;D:\\2025Blog\\my-blog\\source\\_posts&quot;</span>),</span><br><span class="line">    <span class="string">&quot;ALLOWED_EXTENSIONS&quot;</span>: &#123;<span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.jpeg&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.gif&#x27;</span>, <span class="string">&#x27;.bmp&#x27;</span>, <span class="string">&#x27;.webp&#x27;</span>&#125;,</span><br><span class="line">    <span class="string">&quot;HASH_STORE&quot;</span>: Path.home() \ <span class="string">&quot;.image_upload_processed&quot;</span>,</span><br><span class="line">    <span class="string">&quot;LOCAL_IMAGES_DIR&quot;</span>: <span class="literal">None</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="3-3-文件处理管理"><a href="#3-3-文件处理管理" class="headerlink" title="3.3 文件处理管理"></a>3.3 文件处理管理</h3><h4 id="3-3-1-FileProcessor-类"><a href="#3-3-1-FileProcessor-类" class="headerlink" title="3.3.1 FileProcessor 类"></a>3.3.1 <code>FileProcessor</code> 类</h4><ul>
<li>负责初始化 GitHub 连接</li>
<li>读取和存储已处理的文件哈希值</li>
<li>遍历 Markdown 目录，逐个处理文章</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">FileProcessor</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="variable language_">self</span>.processed = <span class="variable language_">self</span>.load_processed()</span><br><span class="line">        <span class="variable language_">self</span>.repo = <span class="variable language_">self</span>.init_github()</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;成功连接仓库: <span class="subst">&#123;self.repo.full_name&#125;</span>\n&quot;</span>)</span><br></pre></td></tr></table></figure>

<h4 id="3-3-2-计算文件哈希值"><a href="#3-3-2-计算文件哈希值" class="headerlink" title="3.3.2 计算文件哈希值"></a>3.3.2 计算文件哈希值</h4><p>用于检查文章是否修改过，避免重复处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_hash</span>(<span class="params">self, filepath</span>):</span><br><span class="line">    hasher = hashlib.sha256()</span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(filepath, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        <span class="keyword">while</span> chunk := f.read(<span class="number">8192</span>):</span><br><span class="line">            hasher.update(chunk)</span><br><span class="line">    <span class="keyword">return</span> hasher.hexdigest()</span><br></pre></td></tr></table></figure>

<h3 id="3-4-文章处理"><a href="#3-4-文章处理" class="headerlink" title="3.4 文章处理"></a>3.4 文章处理</h3><h4 id="3-4-1-ArticleProcessor-类"><a href="#3-4-1-ArticleProcessor-类" class="headerlink" title="3.4.1 ArticleProcessor 类"></a>3.4.1 <code>ArticleProcessor</code> 类</h4><ul>
<li>解析 Markdown 文件，查找图片链接</li>
<li>处理本地图片（检查路径、上传到 GitHub）</li>
<li>替换 Markdown 文章中的本地图片路径</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">process_images</span>(<span class="params">self</span>):</span><br><span class="line">    matches = re.findall(<span class="string">&quot;!\[.*?\]\((.*?)\)&quot;</span>, <span class="variable language_">self</span>.content)</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;发现 <span class="subst">&#123;<span class="built_in">len</span>(matches)&#125;</span> 个图片引用&quot;</span>)</span><br><span class="line">    <span class="keyword">for</span> local_path <span class="keyword">in</span> matches:</span><br><span class="line">        <span class="variable language_">self</span>.process_single_image(local_path)</span><br></pre></td></tr></table></figure>

<h4 id="3-4-2-上传图片到-GitHub"><a href="#3-4-2-上传图片到-GitHub" class="headerlink" title="3.4.2 上传图片到 GitHub"></a>3.4.2 上传图片到 GitHub</h4><ul>
<li>先检查 GitHub 仓库中是否已存在相同文件</li>
<li>如果文件已存在且内容一致，则直接复用 URL</li>
<li>否则更新或创建新的图片文件</li>
</ul>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">upload_image</span>(<span class="params">self, image_path</span>):</span><br><span class="line">    image_name = image_path.name</span><br><span class="line">    remote_path = <span class="string">f&quot;images\&#123;self.article_folder&#125;\&#123;image_name&#125;&quot;</span></span><br><span class="line">    <span class="keyword">with</span> <span class="built_in">open</span>(image_path, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">        content = f.read()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        existing = <span class="variable language_">self</span>.manager.repo.get_contents(remote_path, CONFIG[<span class="string">&quot;BRANCH&quot;</span>])</span><br><span class="line">        <span class="keyword">if</span> existing.decoded_content == content:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">f&quot;图片已存在，跳过上传: <span class="subst">&#123;remote_path&#125;</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;CONFIG[<span class="string">&#x27;BASE_URL&#x27;</span>]&#125;</span><span class="subst">&#123;remote_path&#125;</span>&quot;</span></span><br><span class="line">        <span class="variable language_">self</span>.manager.repo.update_file(</span><br><span class="line">            path=remote_path,</span><br><span class="line">            message=<span class="string">f&quot;Update image: <span class="subst">&#123;remote_path&#125;</span>&quot;</span>,</span><br><span class="line">            content=content,</span><br><span class="line">            sha=existing.sha,</span><br><span class="line">            branch=CONFIG[<span class="string">&quot;BRANCH&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="variable language_">self</span>.manager.repo.create_file(</span><br><span class="line">            path=remote_path,</span><br><span class="line">            message=<span class="string">f&quot;Add image: <span class="subst">&#123;remote_path&#125;</span>&quot;</span>,</span><br><span class="line">            content=content,</span><br><span class="line">            branch=CONFIG[<span class="string">&quot;BRANCH&quot;</span>]</span><br><span class="line">        )</span><br><span class="line">    <span class="keyword">return</span> <span class="string">f&quot;<span class="subst">&#123;CONFIG[<span class="string">&#x27;BASE_URL&#x27;</span>]&#125;</span><span class="subst">&#123;remote_path&#125;</span>&quot;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-5-运行主程序"><a href="#3-5-运行主程序" class="headerlink" title="3.5 运行主程序"></a>3.5 运行主程序</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    CONFIG[<span class="string">&quot;POSTS_DIR&quot;</span>] = Path(CONFIG[<span class="string">&quot;POSTS_DIR&quot;</span>])</span><br><span class="line">    CONFIG[<span class="string">&quot;LOCAL_IMAGES_DIR&quot;</span>] = CONFIG[<span class="string">&quot;POSTS_DIR&quot;</span>].parent \ <span class="string">&quot;images&quot;</span></span><br><span class="line">    CONFIG[<span class="string">&quot;BASE_URL&quot;</span>] = <span class="string">f&quot;https:\\raw.githubusercontent.com\&#123;CONFIG[&#x27;REPO&#x27;]&#125;\&#123;CONFIG[&#x27;BRANCH&#x27;]&#125;\&quot;</span></span><br><span class="line"><span class="string">    </span></span><br><span class="line"><span class="string">    processor = FileProcessor()</span></span><br><span class="line"><span class="string">    processor.process_directory()</span></span><br></pre></td></tr></table></figure>

<h2 id="4-运行方式"><a href="#4-运行方式" class="headerlink" title="4. 运行方式"></a>4. 运行方式</h2><ol>
<li>在 <code>~\.image_upload_config.json</code> 中配置 GitHub Token： <figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;GITHUB_TOKEN&quot;</span><span class="punctuation">:</span> <span class="string">&quot;your_github_personal_access_token&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure></li>
<li>修改 <code>CONFIG</code> 变量，指定 GitHub 仓库和本地 Markdown 目录。</li>
<li>运行 Python 脚本： <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python script.py</span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="5-总结"><a href="#5-总结" class="headerlink" title="5. 总结"></a>5. 总结</h2><p>本代码通过解析 Markdown 文件，自动上传本地图片到 GitHub，并更新文章内容，使得图片可以通过 GitHub 进行托管，适用于 Hexo 或 Jekyll 博客的自动化部署。</p>
<p><img src="https://raw.githubusercontent.com/qingyun201908/qingyun201908.github.io/images/images/%E8%87%AA%E5%8A%A8%E5%8C%96%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87%E5%B7%A5%E5%85%B7/image.png" alt="alt text"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2025/03/05/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/%E8%B7%AF%E4%B8%8E%E5%B7%B1-%E6%AD%A3%E4%B8%80%E9%BE%99%E8%99%8E%E5%B1%B1%E5%A4%A9%E5%B8%88%E5%BC%A0%E4%B9%8B%E7%BB%B4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qing Yun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2025/03/05/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/%E8%B7%AF%E4%B8%8E%E5%B7%B1-%E6%AD%A3%E4%B8%80%E9%BE%99%E8%99%8E%E5%B1%B1%E5%A4%A9%E5%B8%88%E5%BC%A0%E4%B9%8B%E7%BB%B4/" class="post-title-link" itemprop="url">路与己-正一龙虎山天师张之维</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2025-03-05 23:25:13" itemprop="dateCreated datePublished" datetime="2025-03-05T23:25:13+00:00">2025-03-05</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-06 00:32:32" itemprop="dateModified" datetime="2025-06-06T00:32:32+00:00">2025-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/" itemprop="url" rel="index"><span itemprop="name">时间流逝</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="路与己"><a href="#路与己" class="headerlink" title="路与己"></a>路与己</h3><p>张之维：脚在你身上长着，走不走，走哪条路，走什么样的路，做不做人，做什么样的人，亦是如此。</p>
<p>夏禾：太多时候，你我的模样是别人决定的。</p>
<p>张之维：是啊！想走的路不好走，想做人不好做。都说是身不由己，那不是废话嘛，己不由心，身又岂能由己。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/13/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/%E5%86%99%E5%9C%A8%E6%97%B6%E9%97%B4%E4%B9%8B%E5%A4%96%E7%9A%84%E5%BE%80%E4%BA%8B/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Qing Yun">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content=" | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2021/12/13/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/%E5%86%99%E5%9C%A8%E6%97%B6%E9%97%B4%E4%B9%8B%E5%A4%96%E7%9A%84%E5%BE%80%E4%BA%8B/" class="post-title-link" itemprop="url">写在时间之外的往事</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-12-13 10:48:02" itemprop="dateCreated datePublished" datetime="2021-12-13T10:48:02+00:00">2021-12-13</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2025-06-06 00:32:32" itemprop="dateModified" datetime="2025-06-06T00:32:32+00:00">2025-06-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/" itemprop="url" rel="index"><span itemprop="name">时间流逝</span></a>
        </span>
          , 
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E6%97%B6%E9%97%B4%E6%B5%81%E9%80%9D/%E8%BF%87%E5%BE%80/" itemprop="url" rel="index"><span itemprop="name">过往</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h3 id="写在生活之外的往事"><a href="#写在生活之外的往事" class="headerlink" title="写在生活之外的往事"></a>写在生活之外的往事</h3><h4 id="一：为什么不想考研"><a href="#一：为什么不想考研" class="headerlink" title="一：为什么不想考研"></a>一：为什么不想考研</h4><p>没有能力，没有热情，很多时候都不知道自己想去做什么，只是浑浑噩噩的过日子。</p>
<h4 id="二：对不起的人"><a href="#二：对不起的人" class="headerlink" title="二：对不起的人"></a>二：对不起的人</h4><p>于父母有愧，二老对我没太大要求，只是渴望我有更好的发展，不被人欺负，不受气</p>
<h4 id="三：担心害怕的事情"><a href="#三：担心害怕的事情" class="headerlink" title="三：担心害怕的事情"></a>三：担心害怕的事情</h4><p>害怕对不起父母，但是自己又不愿意去承担，假如亲近之人生病，我又该怎么办？没钱，没能力。</p>
<h4 id="四：对待社会"><a href="#四：对待社会" class="headerlink" title="四：对待社会"></a>四：对待社会</h4><p>不怎么喜欢、社会千奇百怪，光怪陆离，就像在地狱一样。</p>
<h4 id="五：为什么写这些？"><a href="#五：为什么写这些？" class="headerlink" title="五：为什么写这些？"></a>五：为什么写这些？</h4><p>我没抑郁症，也没想不开，只是记录下，想着一些事情，就在这里留下！</p>
<h4 id="六：想着依年为单位去完成一些东西"><a href="#六：想着依年为单位去完成一些东西" class="headerlink" title="六：想着依年为单位去完成一些东西"></a>六：想着依年为单位去完成一些东西</h4><p>时间不等人，落叶于枫树飘零，但不知以年为单位的任务，是否能带来改变</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>





</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">

  <div class="copyright">
    &copy; 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="fa fa-heart"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">Qing Yun</span>
  </div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>
  <div class="sidebar-dimmer"></div>
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up fa-lg"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>

</body>
</html>
